set verify off
set linesize 300
set pagesize 6000
/* ligne suivante (chemin disque) à adapter  */
spool C:/Users/4251352/Documents/MONO_UHCD_CCH_2025_old.txt
set termout off
SELECT DISTINCT 
    SDO.KYNOIP AS IPP,
    SDO.NMMAL AS NOM,
    SDO.NMPMAL AS PRENOM,
    EPI.KYNODA AS NDA,
    EPI.UE AS UH,
    EPI.CDURM_P AS UMA, 
    to_char(EPI.D8EEUE,'DD/MM/YYYY') AS DEBUT_EPI,
    to_char(EPI.D8EEUE,'hh24:mi') AS HDEBUT_EPI,
    to_char(EPI.D8SOUE,'DD/MM/YYYY') AS FIN_EPI, 
    to_char(EPI.D8SOUE,'hh24:mi') AS HFIN_EPI,
    EPI.MDSOUE as mdsor,
    (floor((EPI.D8SOUE-EPI.D8EEUE)*24)) as hours_nb
FROM EPI, SDO WHERE EPI.KYNODA = SDO.KYNODA
AND SDO.DASOR >= to_date('01/11/2025','DD/MM/YYYY') 
AND SDO.DASOR  < SYSDATE
AND EPI.UE = '322'
AND 
(
(floor((EPI.D8SOUE-EPI.D8EEUE)*24)) > 24
OR
(EPI.MDSOUE = '9' AND (to_date(SDO.DASOR) - to_date(SDO.DAENTR)) >= 1)
OR
(
 EPI.MDSOUE = '7' AND EPI.TYTRDS in ('1', '2', '4') AND (to_date(SDO.DASOR) - to_date(SDO.DAENTR)) >= 1
 )
)
AND EPI.KYNODA NOT IN
(
SELECT DISTINCT EPI.KYNODA
FROM EPI, SDO WHERE EPI.KYNODA = SDO.KYNODA
AND SDO.DASOR >= to_date('01/11/2025','DD/MM/YYYY') 
AND SDO.DASOR < SYSDATE
AND EPI.UE <> '322' 
)
ORDER BY to_date(to_char(EPI.D8SOUE,'DD/MM/YYYY')) ASC;
spool off
EXIT;


import subprocess
import getpass
import os
from openpyxl import Workbook
import re
import code_decoupage

# Identification pour accès à la base de données
user = input("Veuillez entrer le nom d'utilisateur : ")
password = getpass.getpass("Mot de passe : ")
tns_alias = "SIP1CCH.WORLD"

# Chemin de la requête SQL à modifier si nécessaire
sql_file = r"C:\Users\4251352\Documents\Requetes_du_lundi\monouhcd\MONO_UHCD_CCH.sql"

# Exécution de la requête SQL
cmd = f'sqlplus {user}/{password}@{tns_alias} @{sql_file}'
subprocess.run(
    cmd,
    shell=True
)

# Chemin du fichier texte contenant le résultat de la requête à modifier si nécessaire
txt_file = r"C:\Users\4251352\Documents\MONO_UHCD_CCH_2025_old.txt"

# Ouverture du fichier texte
with open(txt_file, "r", encoding="cp1252") as f:
    lines = [line.rstrip("\n") for line in f if line.strip()]

header_idx = None
for i, line in enumerate(lines):
    if re.match(r"^-{2,}", line.strip()):
        header_idx = i
        break

dash_line = lines[header_idx]
columns = []
in_dash = False
start = 0

# Détection des différentes colonnes du fichier texte
for idx, char in enumerate(dash_line + " "):
    if not in_dash and char == "-":
        in_dash = True
        start = idx
    elif in_dash and char != "-":
        in_dash = False
        columns.append((start, idx))

print(f"Colonnes détectées : {len(columns)}")

# Récupération des noms des colonnes
header_line = lines[header_idx - 1]
headers = [header_line[start:end].strip() for start, end in columns]

# Création du fichier Excel
excel_file = os.path.splitext(txt_file)[0] + ".xlsx"
wb = Workbook()
ws = wb.active
ws.title = "Résultats"

for col_idx, header in enumerate(headers, start=1):
    ws.cell(row=1, column=col_idx, value=header)

# Remplissage du fichier Excel
excel_row = 2
for line in lines[header_idx + 1:]:
    if (
        not line.strip()
        or set(line.strip()) <= {"-"} 
        or re.search(r"ligne\(s\)\s+sélectionnée\(s\)", line)
        or re.search(r"ligne\s+sélectionnée", line)
    ):
        continue

    values = [line[start:end].strip() for start, end in columns]
    for col_idx, value in enumerate(values, start=1):
        ws.cell(row=excel_row, column=col_idx, value=value)
    excel_row += 1

wb.save(excel_file)

excel_final = r"C:\Users\4251352\Documents\MONO_UHCD_CCH.xlsx"
code_decoupage.decouper_excel(excel_file, excel_final)
