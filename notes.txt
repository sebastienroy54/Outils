SELECT MOIS,
       SUM(CASE WHEN METHODE = 'NON_CODE' THEN 1 ELSE 0 END) AS ACTE_NON_CODE,
       SUM(CASE WHEN METHODE = 'CHIR_SANS_AG' THEN 1 ELSE 0 END) AS CHIR_SANS_AG,
       SUM(CASE WHEN METHODE = 'CHIR_SOUS_AG' THEN 1 ELSE 0 END) AS CHIR_SOUS_AG,
       SUM(CASE WHEN METHODE = 'MEDICAMENTEUX' THEN 1 ELSE 0 END) AS MEDICAMENTEUX,
       COUNT(*) AS TOTAL
FROM (
  SELECT DISTINCT
         TO_CHAR(R.D8EEUE,'MM') AS MOIS,
         R.KYRES,
         CASE
           WHEN P.KYRES IS NOT NULL THEN 'MEDICAMENTEUX'
           WHEN D.KYRES IS NOT NULL THEN
                CASE
                  WHEN ROUND((R.D8SOUE - R.D8EEUE) * 24 * 60) >= 330 THEN 'CHIR_SOUS_AG'
                  ELSE 'CHIR_SANS_AG'
                END
           ELSE 'NON_CODE'
         END AS METHODE
  FROM RSM R,
       (SELECT DISTINCT KYRES FROM RAC WHERE KYCDAC LIKE 'JNJ%') J,
       (SELECT DISTINCT KYRES FROM RAC WHERE KYCDAC LIKE 'JNJP%') P,
       (SELECT DISTINCT KYRES FROM RAC WHERE KYCDAC = 'JNJD002') D
  WHERE R.CDURM_P IN ('140J','142J')
    AND R.D8EEUE >= TO_DATE('01/01/2024','DD/MM/YYYY')
    AND R.D8EEUE <  TO_DATE('01/01/2025','DD/MM/YYYY')
    AND J.KYRES(+) = R.KYRES
    AND P.KYRES(+) = R.KYRES
    AND D.KYRES(+) = R.KYRES
    AND (R.CDDNC9 LIKE 'O04%' OR J.KYRES IS NOT NULL)
)
GROUP BY MOIS
ORDER BY MOIS;
