def compute_dmu_totals_in_df(df):
    df["RUM du mois"] = pd.to_numeric(df["RUM du mois"], errors="coerce").fillna(0).astype(int)
    df["RUM cumulés"] = pd.to_numeric(df["RUM cumulés"], errors="coerce").fillna(0).astype(int)

    for idx, row in df.iterrows():
        uma = str(row.get("UMA", "")).strip()
        if uma.startswith("Total DMU"):
            site = str(row.get("Site", "")).strip()
            sum_mois = 0
            sum_cum = 0
            j = idx - 1

            while j >= 0:
                row_site = str(df.at[j, "Site"]).strip()
                row_uma = str(df.at[j, "UMA"]).strip()

                if row_uma.startswith("Total DMU"):  # On s'arrête au total précédent
                    break
                if row_site != site:  # On s'arrête si changement de site
                    break

                sum_mois += df.at[j, "RUM du mois"]
                sum_cum += df.at[j, "RUM cumulés"]
                j -= 1

            df.at[idx, "RUM du mois"] = sum_mois
            df.at[idx, "RUM cumulés"] = sum_cum

from shutil import copyfile

def write_copy_with_values_to_patron(df, patron_path, output_path):

    copyfile(patron_path, output_path)

    wb = load_workbook(filename=str(output_path))
    ws = wb.active

    # Trouver ligne d’en-têtes
    header_row = None
    for r in range(1, 20):
        values = [(ws.cell(row=r, column=c).value or "").strip().lower()
                  for c in range(1, ws.max_column + 1)]
        if "site" in values and "uma" in values:
            header_row = r
            break
    if not header_row:
        header_row = 1  # sécurité

    # Mapper colonnes
    name_to_col = {}
    for c in range(1, ws.max_column + 1):
        val = ws.cell(row=header_row, column=c).value
        if val:
            name_to_col[val.strip().lower()] = c

    col_mois = name_to_col.get("rum du mois")
    col_cum = name_to_col.get("rum cumulés")

    if not col_mois or not col_cum:
        raise KeyError("Colonnes RUM absentes dans le patron")

    start = header_row + 1

    # Injecter données dans la copie
    for i in range(len(df)):
        row = start + i
        ws.cell(row=row, column=col_mois).value = int(df.at[i, "RUM du mois"])
        ws.cell(row=row, column=col_cum).value = int(df.at[i, "RUM cumulés"])

    wb.save(output_path)
