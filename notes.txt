out_mois = run_sqlplus_and_wait(
    f"sqlplus -S {st.session_state.oracle_user}/{st.session_state.oracle_password}@{tns} @{tmp_sql_mois}",
    timeout=60
)
out_cum = run_sqlplus_and_wait(
    f"sqlplus -S {st.session_state.oracle_user}/{st.session_state.oracle_password}@{tns} @{tmp_sql_cum}",
    timeout=60
)

# Debug: afficher la sortie uniquement pour HTD (ou si ORA-/SP2- détecté)
def looks_like_sqlplus_error(txt: str) -> bool:
    if not txt:
        return False
    return ("ORA-" in txt) or ("SP2-" in txt)

if site_label == "HTD" or looks_like_sqlplus_error(out_mois) or looks_like_sqlplus_error(out_cum):
    st.subheader(f"Debug SQL*Plus — {site_label}")
    st.write("Sortie MOIS :")
    st.code(out_mois[-4000:] if out_mois else "(vide)")
    st.write("Sortie CUMUL :")
    st.code(out_cum[-4000:] if out_cum else "(vide)")
