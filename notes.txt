def creer_tableau_comparatif(df_new, annee_new, df_old, annee_old):
    """Fusionne les DataFrames et calcule l'écart, en conservant l'ordre de df_new."""
    df_new = df_new.rename(columns={
        "Valorisation": f"Valorisation {annee_new}",
        "Quantité": f"Quantité {annee_new}",
        "Unité": f"Unité {annee_new}"
    })
    df_old = df_old.rename(columns={
        "Valorisation": f"Valorisation {annee_old}",
        "Quantité": f"Quantité {annee_old}",
        "Unité": f"Unité {annee_old}"
    })

    # Ajouter colonne temporaire pour l'ordre
    df_new["__order__"] = range(len(df_new))

    # Merge
    df_merge = pd.merge(df_new, df_old, on="Indicateur", how="outer")

    # Reclasser selon l'ordre original du fichier récent
    df_merge = df_merge.sort_values("__order__").reset_index(drop=True)
    df_merge = df_merge.drop(columns="__order__")

    # Calcul de l'écart
    df_merge[f"Écart Valorisation ({annee_new}-{annee_old})"] = (
        df_merge[f"Valorisation {annee_new}"] - df_merge[f"Valorisation {annee_old}"]
    )

    return df_merge
