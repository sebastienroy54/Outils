#!/usr/bin/env python3
"""
Compare deux fichiers CSV (séparateur ;) au caractère près.
- Compare ligne par ligne
- Compare champ par champ
- Indique la ligne, la colonne et la première position différente
"""

import csv
import itertools
import sys

# =========================
# FICHIERS À COMPARER
# =========================
FILE_1 = "SX273302.csv"
FILE_2 = "SX272586.csv"

MAX_DIFFS = 50  # limite d'affichage


def first_diff_pos(a: str, b: str):
    """Retourne l'index du premier caractère différent (0-based) ou None"""
    n = min(len(a), len(b))
    for i in range(n):
        if a[i] != b[i]:
            return i
    if len(a) != len(b):
        return n
    return None


def visible(s: str) -> str:
    """Rend visibles les caractères invisibles"""
    return (
        s.replace("\t", "\\t")
         .replace("\r", "\\r")
         .replace("\n", "\\n")
    )


def read_csv(path: str):
    with open(path, "r", encoding="utf-8", errors="replace", newline="") as f:
        reader = csv.reader(f, delimiter=";")
        return list(reader)


def compare_csv(f1: str, f2: str, max_diffs: int = 50) -> int:
    rows1 = read_csv(f1)
    rows2 = read_csv(f2)

    diffs = 0
    exit_code = 0

    for row_idx, (r1, r2) in enumerate(
        itertools.zip_longest(rows1, rows2, fillvalue=None), start=1
    ):

        if r1 is None or r2 is None:
            exit_code = 1
            diffs += 1
            print(f"\n[Ligne {row_idx}] Nombre de lignes différent")
            print(f"  {f1}: {r1 if r1 is not None else '<EOF>'}")
            print(f"  {f2}: {r2 if r2 is not None else '<EOF>'}")
            continue

        for col_idx, (c1, c2) in enumerate(
            itertools.zip_longest(r1, r2, fillvalue=None), start=1
        ):

            if c1 == c2:
                continue

            exit_code = 1
            diffs += 1
            if diffs > max_diffs:
                continue

            print(f"\n[Ligne {row_idx}, Colonne {col_idx}] DIFF")
            print(f"  {f1}: '{visible(c1) if c1 is not None else '<VIDE>'}'")
            print(f"  {f2}: '{visible(c2) if c2 is not None else '<VIDE>'}'")

            if c1 is not None and c2 is not None:
                pos = first_diff_pos(c1, c2)
                if pos is not None:
                    print(f"  Première différence caractère : position {pos} (colonne {pos+1})")
                    print("   " + " " * pos + "^")

    if diffs == 0:
        print("✅ Aucun écart détecté (CSV strictement identiques).")
    elif diffs > max_diffs:
        print(f"\n⚠️ {diffs} différences détectées (affichage limité à {max_diffs}).")
    else:
        print(f"\n❌ {diffs} différence(s) détectée(s).")

    return exit_code


if __name__ == "__main__":
    sys.exit(compare_csv(FILE_1, FILE_2, MAX_DIFFS))
