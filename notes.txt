import streamlit as st
import pandas as pd
from io import BytesIO
from openpyxl import Workbook
from openpyxl.styles import Font, Alignment

# -----------------------
# Helpers
# -----------------------
def safe_show_exception(e):
    st.error("Une erreur est survenue pendant le traitement. V√©rifiez vos fichiers ou contactez le support.")
    if st.checkbox("Afficher les d√©tails techniques (pour un d√©veloppeur)"):
        st.exception(e)

def lire_fichier_excel(fichier):
    """Lit un fichier Excel et renvoie ann√©e, tableau et m√©tadonn√©es."""
    df = pd.read_excel(fichier, header=None, dtype=str, engine='openpyxl')

    # R√©cup√©ration des m√©tadonn√©es
    resume_filtrage = df.iloc[3, 0]
    periode = str(df.iloc[4, 0])
    filtres = df.iloc[5, 0]
    detail_valo = df.iloc[7, 0]

    # Extraction de l'ann√©e
    import re
    match = re.search(r"(\d{4})", periode)
    annee = match.group(1) if match else "XXXX"

    # Lecture du tableau de donn√©es √† partir de la ligne 9 (index 8)
    data = pd.read_excel(fichier, header=8, dtype=str, engine='openpyxl')
    data = data.iloc[:, :4]
    data.columns = ["Indicateur", "Valorisation", "Quantit√©", "Unit√©"]

    # Conversion des colonnes num√©riques
    data["Valorisation"] = pd.to_numeric(data["Valorisation"], errors='coerce')
    data["Quantit√©"] = pd.to_numeric(data["Quantit√©"], errors='coerce')

    return annee, data, {
        "R√©sum√© de filtrage": resume_filtrage,
        "P√©riode": periode,
        "Filtres": filtres,
        "D√©tail valorisation": detail_valo
    }

def creer_tableau_comparatif(df_new, annee_new, df_old, annee_old):
    """Fusionne les DataFrames et calcule l'√©cart de valorisation."""
    df_new = df_new.rename(columns={
        "Valorisation": f"Valorisation {annee_new}",
        "Quantit√©": f"Quantit√© {annee_new}",
        "Unit√©": f"Unit√© {annee_new}"
    })
    df_old = df_old.rename(columns={
        "Valorisation": f"Valorisation {annee_old}",
        "Quantit√©": f"Quantit√© {annee_old}",
        "Unit√©": f"Unit√© {annee_old}"
    })

    df_merge = pd.merge(df_new, df_old, on="Indicateur", how="outer")
    df_merge[f"√âcart Valorisation ({annee_new}-{annee_old})"] = (
        df_merge[f"Valorisation {annee_new}"] - df_merge[f"Valorisation {annee_old}"]
    )
    return df_merge

def format_valeur_monetaire(val):
    """Format mon√©taire avec espace et ‚Ç¨."""
    if pd.isna(val):
        return ""
    return f"{val:,.0f}".replace(",", " ") + " ‚Ç¨"

def generer_excel(df, annee_new, annee_old):
    """G√©n√®re un fichier Excel avec mise en forme."""
    output = BytesIO()
    wb = Workbook()
    ws = wb.active
    ws.title = "Comparatif"

    # Titre
    titre = f"Comparatif {annee_new} vs {annee_old}"
    ws.cell(row=1, column=1, value=titre)
    ws.cell(row=1, column=1).font = Font(size=14, bold=True)
    ws.cell(row=1, column=1).alignment = Alignment(horizontal="center")

    # √âcrire les en-t√™tes
    for j, col in enumerate(df.columns, start=1):
        ws.cell(row=2, column=j, value=col).font = Font(bold=True)

    # √âcrire les donn√©es
    for i, row in enumerate(df.values, start=3):
        for j, val in enumerate(row, start=1):
            cell = ws.cell(row=i, column=j, value=val)
            # Format mon√©taire
            if isinstance(val, (int, float)) and ("Valorisation" in df.columns[j-1] or "√âcart Valorisation" in df.columns[j-1]):
                cell.value = format_valeur_monetaire(val)
                if val < 0:
                    cell.font = Font(color="FF0000")
            # Quantit√© en entier
            if "Quantit√©" in df.columns[j-1] and pd.notna(val):
                cell.value = int(val)

    wb.save(output)
    output.seek(0)
    return output

def afficher_tableau_colore(df, annee_new, annee_old):
    """Affiche le tableau dans Streamlit avec rouge pour valeurs n√©gatives."""
    valorisation_cols = [c for c in df.columns if "Valorisation" in c or "√âcart Valorisation" in c]

    def color_neg(v):
        try:
            val = float(v)
            return 'color: red' if val < 0 else ''
        except:
            return ''

    st.dataframe(df.style.applymap(color_neg, subset=valorisation_cols))

# -----------------------
# main
# -----------------------
def main():
    st.title("üí∂ Comparateur de Valorisation T2A")
    st.write("### üóÇÔ∏è Importez les deux fichiers Excel")

    fichier1 = st.file_uploader("Fichier r√©cent (ex: 2025)", type=["xlsx"], key="file1")
    fichier2 = st.file_uploader("Fichier ancien (ex: 2024)", type=["xlsx"], key="file2")

    if fichier1 and fichier2:
        annee1, df1, meta1 = lire_fichier_excel(fichier1)
        annee2, df2, meta2 = lire_fichier_excel(fichier2)

        # Swap si fichiers invers√©s
        if int(annee1) < int(annee2):
            st.warning(f"Inversion d√©tect√©e : {annee1} < {annee2}. Correction automatique.")
            df1, df2 = df2, df1
            annee1, annee2 = annee2, annee1

        st.write(f"**P√©riode {annee1}:** {meta1['P√©riode']}")
        st.write(f"**P√©riode {annee2}:** {meta2['P√©riode']}")

        df_comparatif = creer_tableau_comparatif(df1, annee1, df2, annee2)
        afficher_tableau_colore(df_comparatif, annee1, annee2)

        excel_data = generer_excel(df_comparatif, annee1, annee2)
        st.download_button(
            label="üíæ T√©l√©charger le comparatif (Excel)",
            data=excel_data,
            file_name=f"Comparatif_{annee1}_{annee2}.xlsx",
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )

if __name__ == "__main__":
    main()
