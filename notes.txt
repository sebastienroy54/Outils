#!/usr/bin/env python3
"""
Compare uniquement la première ligne (en-tête) de deux CSV
au caractère près (séparateur ;)
"""

import csv
import sys

# =========================
# FICHIERS À COMPARER
# =========================
FILE_1 = "SX273302.csv"
FILE_2 = "SX272586.csv"


def first_diff_pos(a: str, b: str):
    n = min(len(a), len(b))
    for i in range(n):
        if a[i] != b[i]:
            return i
    if len(a) != len(b):
        return n
    return None


def visible(s: str) -> str:
    return (
        s.replace("\t", "\\t")
         .replace("\r", "\\r")
         .replace("\n", "\\n")
    )


def read_header(path: str):
    with open(path, "r", encoding="utf-8", errors="replace", newline="") as f:
        reader = csv.reader(f, delimiter=";")
        return next(reader, None)


def compare_headers(f1: str, f2: str) -> int:
    h1 = read_header(f1)
    h2 = read_header(f2)

    if h1 is None or h2 is None:
        print("❌ Impossible de lire l'en-tête d'un des fichiers")
        return 1

    if h1 == h2:
        print("✅ En-têtes strictement identiques (colonnes et ordre).")
        return 0

    print("❌ Différences détectées dans l'en-tête")

    max_len = max(len(h1), len(h2))
    for idx in range(max_len):
        c1 = h1[idx] if idx < len(h1) else None
        c2 = h2[idx] if idx < len(h2) else None

        if c1 == c2:
            continue

        print(f"\nColonne {idx + 1}")
        print(f"  {f1}: '{visible(c1) if c1 is not None else '<ABSENTE>'}'")
        print(f"  {f2}: '{visible(c2) if c2 is not None else '<ABSENTE>'}'")

        if c1 is not None and c2 is not None:
            pos = first_diff_pos(c1, c2)
            if pos is not None:
                print(f"  Première différence caractère : position {pos} (colonne {pos+1})")
                print("   " + " " * pos + "^")

    return 1


if __name__ == "__main__":
    sys.exit(compare_headers(FILE_1, FILE_2))
