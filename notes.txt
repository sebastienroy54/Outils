-	vrais doublons (NDA1 <> NDA2 and UMA1 = UMA2 and DateE1 = DateE2 and DateS1 = DateS2) ;
-	autres doublons 0 nuit (NDA1 <> NDA2 and UMA1 <> UMA2 and DateE1 = DateE2 and DateS1 = DateS2) ;
-	séjours en chevauchement ou en inclusion (NDA1 <> NDA2 and UMA1 <> UMA2 and DateS1 between DE1+1 et Dates2) ;
-	séjours contigus (NDA1 <> NDA2 and UMA1 <> UMA2 and Dates1 = DateE2).


# memory dump + packages
gc()
# Loading libraries
library(tidyr)
library(dplyr)
library(stringr)
library("readxl")

####### ********** A PARAMETRER ************#############
chemin = "C:/Users/4023620/Documents/R/CONTIGUS"
# an = "2021"
# mois_uma = "09"
# mois_rimp = as.numeric(mois)
# UMA_HTD = paste("CORREPONDANCE_UM_PSY_SITE_00041_APHP_",an,mois_uma,".xls",sep="")
# UMA_CCH = paste("CORREPONDANCE_UM_PSY_SITE_00021_APHP_",an,mois_uma,".xls",sep="")
# RAA_HTD = paste("750100018.",an,".",strtoi(mois_rimp),".rpa.txt",sep="")
# RAA_CCH = paste("750100166.",an,".",strtoi(mois_rimp),".rpa.txt",sep="")
# RPS_HTD = paste("750100018.",an,".",strtoi(mois_rimp),".rps.txt",sep="")
# RPS_CCH = paste("750100166.",an,".",strtoi(mois_rimp),".rps.txt",sep="")
# # nom des fichiers de sortie
# RAA_HTD_SITE = paste(str_sub(RAA_HTD, start = 1, end = nchar(RAA_HTD)-4),".site",str_sub(RAA_HTD, start = nchar(RAA_HTD)-3),sep="")
# RAA_CCH_SITE = paste(str_sub(RAA_CCH, start = 1, end = nchar(RAA_CCH)-4),".site",str_sub(RAA_CCH, start = nchar(RAA_CCH)-3),sep="")
# RPS_HTD_SITE = paste(str_sub(RPS_HTD, start = 1, end = nchar(RPS_HTD)-4),".site",str_sub(RPS_HTD, start = nchar(RPS_HTD)-3),sep="")
# RPS_CCH_SITE = paste(str_sub(RPS_CCH, start = 1, end = nchar(RPS_CCH)-4),".site",str_sub(RPS_CCH, start = nchar(RPS_CCH)-3),sep="")
# 
# # format RIM-P
# taille_um = 4
# deb_pos_UM_RAA = 58
# deb_pos_UM_RPS = 98
# chemin    
setwd (chemin)

# UM_CCH<-read_excel(UMA_CCH, skip  = 2)

# lecture fichier sql simpa (nb_ipp > 1)
EPI<-read.table(file = "CONTIGUS_2.txt", header = TRUE)
# class(EPI$ENTREE)
EPI$ENTREE2=0:0
EPI$SORTIE2=0:0
EPI$ENTREE2=as.Date(EPI$ENTREE, format="%d/%m/%Y")
EPI$SORTIE2=as.Date(EPI$SORTIE, format="%d/%m/%Y")
# class(EPI$ENTREE2)


#ajout de 2 colonne de calcul interm�diaire
EPI$dur�e=0:0

# recherche RUMs contigus
EPI2<-EPI%>%group_by(IPP)%>%arrange(IPP, ENTREE2, SORTIE2, .by_group=TRUE)%>%
mutate(dur�e=ENTREE2-lag(SORTIE2), prev.NDA = lag(NDA),
       dur�e2=SORTIE2-lead(ENTREE2), next.NDA = lead(NDA))%>%
filter((NDA != prev.NDA & dur�e == 0)| (NDA != next.NDA & dur�e2 == 0))
#filter(NDA != prev.NDA, dur�e == 0 | NDA != next.NDA, dur�e2 == 0)
write.table(EPI2, file = "sej_contig2.txt")
