import subprocess
import getpass
import os
from openpyxl import Workbook
import re
import code_decoupage

# Identification pour accès à la base de données
user = input("Veuillez entrer le nom d'utilisateur : ")
password = getpass.getpass("Mot de passe : ")
tns_alias = "o-simpa-b1.cch.aphp.fr"

# Chemin de la requête SQL à modifier si nécessaire
sql_file = r"C:\Users\4251352\Documents\Requetes_du_lundi\monouhcd\MONO_UHCD_CCH.sql"

# Exécution de la requête SQL
cmd = f'sqlplus {user}/{password}@{tns_alias} @{sql_file}'
subprocess.run(
    cmd,
    shell=True
)

# Chemin du fichier texte contenant le résultat de la requête à modifier si nécessaire
txt_file = r"C:\Users\4251352\Documents\MONO_UHCD_CCH_2025_old.txt"

# Ouverture du fichier texte
with open(txt_file, "r", encoding="cp1252") as f:
    lines = [line.rstrip("\n") for line in f if line.strip()]

header_idx = None
for i, line in enumerate(lines):
    if re.match(r"^-{2,}", line.strip()):
        header_idx = i
        break

dash_line = lines[header_idx]
columns = []
in_dash = False
start = 0

# Détection des différentes colonnes du fichier texte
for idx, char in enumerate(dash_line + " "):
    if not in_dash and char == "-":
        in_dash = True
        start = idx
    elif in_dash and char != "-":
        in_dash = False
        columns.append((start, idx))

print(f"Colonnes détectées : {len(columns)}")

# Récupération des noms des colonnes
header_line = lines[header_idx - 1]
headers = [header_line[start:end].strip() for start, end in columns]

# Création du fichier Excel
excel_file = os.path.splitext(txt_file)[0] + ".xlsx"
wb = Workbook()
ws = wb.active
ws.title = "Résultats"

for col_idx, header in enumerate(headers, start=1):
    ws.cell(row=1, column=col_idx, value=header)

# Remplissage du fichier Excel
excel_row = 2
for line in lines[header_idx + 1:]:
    if (
        not line.strip()
        or set(line.strip()) <= {"-"} 
        or re.search(r"ligne\(s\)\s+sélectionnée\(s\)", line)
        or re.search(r"ligne\s+sélectionnée", line)
    ):
        continue

    values = [line[start:end].strip() for start, end in columns]
    for col_idx, value in enumerate(values, start=1):
        ws.cell(row=excel_row, column=col_idx, value=value)
    excel_row += 1

wb.save(excel_file)

excel_final = r"C:\Users\4251352\Documents\MONO_UHCD_CCH.xlsx"
code_decoupage.decouper_excel(excel_file, excel_final)



import subprocess
import getpass
import os
from openpyxl import Workbook
import re
import code_decoupage_htd

# Identification pour accès à la base de données
user = input("Veuillez entrer le nom d'utilisateur : ")
password = getpass.getpass("Mot de passe : ")
tns_alias = "o-simpa-b1.htd.aphp.fr"

# Chemin de la requête SQL à modifier si nécessaire
sql_file = r"C:\Users\4251352\Documents\Requetes_du_lundi\monouhcd\MONO_UHCD_HTD.sql"

# Exécution de la requête SQL
cmd = f'sqlplus {user}/{password}@{tns_alias} @{sql_file}'
subprocess.run(
    cmd,
    shell=True
)

# Chemin du fichier texte contenant le résultat de la requête à modifier si nécessaire
txt_file = r"C:\Users\4251352\Documents\MONO_UHCD_HTD_2025_old.txt"

# Ouverture du fichier texte
with open(txt_file, "r", encoding="cp1252") as f:
    lines = [line.rstrip("\n") for line in f if line.strip()]

header_idx = None
for i, line in enumerate(lines):
    if re.match(r"^-{2,}", line.strip()):
        header_idx = i
        break

dash_line = lines[header_idx]
columns = []
in_dash = False
start = 0

# Détection des différentes colonnes du fichier texte
for idx, char in enumerate(dash_line + " "):
    if not in_dash and char == "-":
        in_dash = True
        start = idx
    elif in_dash and char != "-":
        in_dash = False
        columns.append((start, idx))

print(f"Colonnes détectées : {len(columns)}")

# Récupération des noms des colonnes
header_line = lines[header_idx - 1]
headers = [header_line[start:end].strip() for start, end in columns]

# Création du fichier Excel
excel_file = os.path.splitext(txt_file)[0] + ".xlsx"
wb = Workbook()
ws = wb.active
ws.title = "Résultats"

for col_idx, header in enumerate(headers, start=1):
    ws.cell(row=1, column=col_idx, value=header)

# Remplissage du fichier Excel
excel_row = 2
for line in lines[header_idx + 1:]:
    if (
        not line.strip()
        or set(line.strip()) <= {"-"} 
        or re.search(r"ligne\(s\)\s+sélectionnée\(s\)", line)
        or re.search(r"ligne\s+sélectionnée", line)
    ):
        continue

    values = [line[start:end].strip() for start, end in columns]
    for col_idx, value in enumerate(values, start=1):
        ws.cell(row=excel_row, column=col_idx, value=value)
    excel_row += 1

wb.save(excel_file)

excel_final = r"C:\Users\4251352\Documents\MONO_UHCD_HTD.xlsx"
code_decoupage_htd.decouper_excel(excel_file, excel_final)

import pandas as pd
from datetime import datetime, timedelta
import os

# input_file = r"C:\Users\4251352\Documents\MONO_UHCD_CCH_2025_old.xlsx"
# output_file = r"C:\Users\4251352\Documents\MONO_UHCD_CCH_2025_decoupé.xlsx"

def decouper_excel(input_file, output_file, date_cols=["DEBUT_EPI", "FIN_EPI"], month_start_str=None, month_end_str=None):
    df = pd.read_excel(input_file)

    for col in date_cols:
        if col in df.columns:
            df[col] = pd.to_datetime(df[col], dayfirst=True, errors='coerce')

    today = pd.Timestamp.today().normalize()
    week_start = today - pd.Timedelta(days=7)
    week_end = today

    if month_start_str is None or month_end_str is None:
        month_start = today.replace(day=1)
        if month_start.month == 12:
            next_month_start = month_start.replace(year=month_start.year + 1, month=1, day=1)
        else:
            next_month_start = month_start.replace(month=month_start.month + 1, day=1)
        month_end = next_month_start - pd.Timedelta(days=1)
    else:
        month_start = pd.to_datetime(month_start_str).normalize()
        month_end = pd.to_datetime(month_end_str).normalize()

    year_start = pd.Timestamp(today.year, 1, 1)

    def in_range(col, start, end, inclusive_end=False):
        if col not in df.columns:
            return pd.Series(False, index=df.index)
        if inclusive_end:
            return (df[col] >= start) & (df[col] <= end)
        else:
            return (df[col] >= start) & (df[col] < end)

    mask_week = in_range("DEBUT_EPI", week_start, week_end) | in_range("FIN_EPI", week_start, week_end)
    mask_month = in_range("DEBUT_EPI", month_start, month_end, inclusive_end=True) | in_range("FIN_EPI", month_start, month_end, inclusive_end=True)
    mask_year = in_range("DEBUT_EPI", year_start, month_start) | in_range("FIN_EPI", year_start, month_start)

    SEMAINE_CCH = df[mask_week].sort_values(by='DEBUT_EPI', na_position='last').copy()
    MOIS_CCH = df[mask_month].sort_values(by='DEBUT_EPI', na_position='last').copy()
    ANNEE_CCH = df[mask_year].sort_values(by='DEBUT_EPI', na_position='last').copy()

    if 'IPP' in df.columns:
        ipp_semaine = set(SEMAINE_CCH['IPP'].dropna().astype(str))
        ipp_mois = set(MOIS_CCH['IPP'].dropna().astype(str))
        MOIS_CCH = MOIS_CCH[~MOIS_CCH['IPP'].astype(str).isin(ipp_semaine)]
        ANNEE_CCH = ANNEE_CCH[~ANNEE_CCH['IPP'].astype(str).isin(ipp_semaine | ipp_mois)]
    
    def format_dates_for_export(df_in):
        df_out = df_in.copy()
        for col in date_cols:
            if col in df_out.columns:
                df_out[col] = df_out[col].dt.strftime('%d/%m/%Y')
        return df_out
    
    SEMAINE_EXPORT = format_dates_for_export(SEMAINE_CCH)
    MOIS_EXPORT = format_dates_for_export(MOIS_CCH)
    ANNEE_EXPORT = format_dates_for_export(ANNEE_CCH)

    with pd.ExcelWriter(output_file, engine='openpyxl') as writer:
        SEMAINE_EXPORT.to_excel(writer, sheet_name='SEMAINE_CCH', index=False)
        MOIS_EXPORT.to_excel(writer, sheet_name='MOIS_CCH', index=False)
        ANNEE_EXPORT.to_excel(writer, sheet_name='ANNEE_CCH', index=False)


import pandas as pd
from datetime import datetime, timedelta
import os
from openpyxl import load_workbook
from openpyxl.styles import numbers

def decouper_excel(input_file, output_file, date_cols=["DEBUT_EPI", "FIN_EPI"], month_start_str=None, month_end_str=None):
    df = pd.read_excel(input_file)

    for col in date_cols:
        if col in df.columns:
            df[col] = pd.to_datetime(df[col], dayfirst=True, errors='coerce')

    today = pd.Timestamp.today().normalize()
    week_start = today - pd.Timedelta(days=7)
    week_end = today

    if month_start_str is None or month_end_str is None:
        month_start = today.replace(day=1)
        if month_start.month == 12:
            next_month_start = month_start.replace(year=month_start.year + 1, month=1, day=1)
        else:
            next_month_start = month_start.replace(month=month_start.month + 1, day=1)
        month_end = next_month_start - pd.Timedelta(days=1)
    else:
        month_start = pd.to_datetime(month_start_str).normalize()
        month_end = pd.to_datetime(month_end_str).normalize()

    year_start = pd.Timestamp(today.year, 1, 1)

    def in_range(col, start, end, inclusive_end=False):
        if col not in df.columns:
            return pd.Series(False, index=df.index)
        if inclusive_end:
            return (df[col] >= start) & (df[col] <= end)
        else:
            return (df[col] >= start) & (df[col] < end)

    mask_week = in_range("DEBUT_EPI", week_start, week_end) | in_range("FIN_EPI", week_start, week_end)
    mask_month = in_range("DEBUT_EPI", month_start, month_end, inclusive_end=True) | in_range("FIN_EPI", month_start, month_end, inclusive_end=True)
    mask_year = in_range("DEBUT_EPI", year_start, month_start) | in_range("FIN_EPI", year_start, month_start)

    SEMAINE_CCH = df[mask_week].sort_values(by='DEBUT_EPI', na_position='last').copy()
    MOIS_CCH = df[mask_month].sort_values(by='DEBUT_EPI', na_position='last').copy()
    ANNEE_CCH = df[mask_year].sort_values(by='DEBUT_EPI', na_position='last').copy()

    if 'IPP' in df.columns:
        ipp_semaine = set(SEMAINE_CCH['IPP'].dropna().astype(str))
        ipp_mois = set(MOIS_CCH['IPP'].dropna().astype(str))
        MOIS_CCH = MOIS_CCH[~MOIS_CCH['IPP'].astype(str).isin(ipp_semaine)]
        ANNEE_CCH = ANNEE_CCH[~ANNEE_CCH['IPP'].astype(str).isin(ipp_semaine | ipp_mois)]
    
    def format_dates_for_export(df_in):
        df_out = df_in.copy()
        for col in date_cols:
            if col in df_out.columns:
                df_out[col] = df_out[col].dt.strftime('%d/%m/%Y')
        return df_out
    
    SEMAINE_EXPORT = format_dates_for_export(SEMAINE_CCH)
    MOIS_EXPORT = format_dates_for_export(MOIS_CCH)
    ANNEE_EXPORT = format_dates_for_export(ANNEE_CCH)

    with pd.ExcelWriter(output_file, engine='openpyxl') as writer:
        SEMAINE_EXPORT.to_excel(writer, sheet_name='SEMAINE_CCH', index=False)
        MOIS_EXPORT.to_excel(writer, sheet_name='MOIS_CCH', index=False)
        ANNEE_EXPORT.to_excel(writer, sheet_name='ANNEE_CCH', index=False)
