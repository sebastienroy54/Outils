/* UHCD -> MI (porte d'entrée) : 1 UHCD retenu (le dernier) par séjour MI
   Sortie : IPP ; NDA ; UMA ; Date entree ; Date sortie
*/

SET HEADING ON
SET FEEDBACK OFF
SET PAGESIZE 6000
SET LINESIZE 300
SET COLSEP ';'
SET TRIMSPOOL ON
SET WRAP OFF
SET TERMOUT OFF

SPOOL C:\Users\4251352\Documents\Resultats_requetes\passage_UHCD_MI.csv

SELECT
  x.IPP,
  x.NDA,
  x.UMA,
  TO_CHAR(x.ENTREE,'DD/MM/YYYY HH24:MI:SS') AS DATE_ENTREE,
  TO_CHAR(x.SORTIE,'DD/MM/YYYY HH24:MI:SS') AS DATE_SORTIE
FROM (
  SELECT
    mi.NOIP   AS IPP,

    uh.NODA   AS NDA,
    uh.CDURM_P AS UMA,
    uh.D8EEUE AS ENTREE,
    uh.D8SOUE AS SORTIE,

    ROW_NUMBER() OVER (
      PARTITION BY mi.KYRES
      ORDER BY uh.D8SOUE DESC
    ) AS rn
  FROM
    RSM mi,
    RSM uh
  WHERE
    mi.CDURM_P IN ('010','010S')
    AND mi.D8EEUE >= TO_DATE('01/01/2025','DD/MM/YYYY')
    AND mi.D8EEUE <  TO_DATE('01/01/2026','DD/MM/YYYY')

    AND uh.NOIP = mi.NOIP
    AND uh.CDURM_P IN ('540','543')
    AND uh.D8SOUE <= mi.D8EEUE
    AND uh.D8SOUE >= (mi.D8EEUE - 1)   -- fenêtre 1 jour incluse
) x
WHERE x.rn = 1
ORDER BY x.IPP, x.SORTIE;

SPOOL OFF
