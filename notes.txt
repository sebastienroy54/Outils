def main():
    st.title("Croisement Fichiers Excel BHRe")
    
    # ---------- Connexion Oracle ----------
    if "oracle_connected" not in st.session_state:
        st.session_state.oracle_connected = False

    if not st.session_state.oracle_connected:
        with st.form("connexion"):
            st.subheader("Connexion Oracle")
            user = st.text_input("ðŸ‘¤ Nom d'utilisateur Oracle :", value="")
            password = st.text_input("ðŸ”‘ Mot de passe :", type="password")
            submitted = st.form_submit_button("ðŸš€ Se connecter")

        if submitted:
            if not user or not password:
                st.error("Veuillez renseigner vos identifiants Oracle.")
                st.stop()
            else:
                # On considÃ¨re la connexion OK si les champs sont remplis
                st.session_state.oracle_user = user
                st.session_state.oracle_password = password
                st.session_state.oracle_connected = True
                st.success("âœ… Connexion rÃ©ussie !")
                st.experimental_rerun()
        return

    # ---------- Drag & Drop des fichiers ----------
    st.write("### ðŸ—‚ï¸ Importez les trois fichiers Excel")
    fichier1 = st.file_uploader("Fichier Indicateur (F1)", type=["xlsx"])
    fichier2 = st.file_uploader("Fichier Suivi TerminÃ© (F2)", type=["xlsx"])
    fichier3 = st.file_uploader("Fichier Suivi (F3)", type=["xlsx"])
    debug = st.checkbox("Afficher mode debug")

    if fichier1 and fichier2 and fichier3:
        try:
            progress = st.progress(0)

            # --- DÃ©tection F1 ---
            df1, feuil1, ligne1 = trouver_feuille_avec_colonnes(
                fichier1, ["c", "prÃ©nom"], debug=debug
            )
            st.success(f"Fichier 1 â†’ feuille : {feuil1} (header ligne {ligne1})")
            progress.progress(20)

            # --- DÃ©tection F2 ---
            df2, feuil2, ligne2 = trouver_feuille_avec_colonnes(
                fichier2, ["nom", "prÃ©nom", "ddn", "nip"], debug=debug
            )
            st.success(f"Fichier 2 â†’ feuille : {feuil2} (header ligne {ligne2})")
            progress.progress(40)

            # --- DÃ©tection F3 ---
            df3, feuil3, ligne3 = trouver_feuille_avec_colonnes(
                fichier3, ["nom", "prÃ©nom", "ddn", "ipp"], debug=debug
            )
            st.success(f"Fichier 3 â†’ feuille : {feuil3} (header ligne {ligne3})")
            progress.progress(60)

            # --- Fusion ---
            st.info("ðŸ”— Fusion des fichiers...")
            df_result = fusion_excel(df1, df2, df3)
            st.success("Fusion terminÃ©e !")
            st.dataframe(df_result.head())
            progress.progress(80)

            # --- Export Fusion Excel ---
            fusion_path = "C:/Users/4251352/Portail_outils/data/Fusion_excel.xlsx"
            with open(fusion_path, "wb") as f:
                f.write(generer_excel(df_result))
            st.success(f"Fichier Fusion enregistrÃ© â†’ {fusion_path}")

            # --- GÃ©nÃ©ration fichier SQL ---
            from pathlib import Path
            SQL_BASE = "C:/Users/4251352/Portail_outils/SQL/BHRe.sql"
            SQL_TEMP = "C:/Users/4251352/Portail_outils/SQL/BHRe_temp.sql"
            liste_ipps = df_result["ipp"].dropna().unique().tolist()
            ipps_txt = ",".join(f"'{ipp}'" for ipp in liste_ipps)
            sql_base = Path(SQL_BASE).read_text(encoding="utf-8")
            sql_final = sql_base.replace("--IPP_PLACEHOLDER--", ipps_txt)
            Path(SQL_TEMP).write_text(sql_final, encoding="utf-8")

            # --- ExÃ©cution SQL via subprocess ---
            st.info("ðŸ§  ExÃ©cution de la requÃªte SQL...")
            tns_alias = "SIP1CCH.WORLD"
            cmd_sql = f"sqlplus {st.session_state.oracle_user}/{st.session_state.oracle_password}@{tns_alias} @{SQL_TEMP}"
            subprocess.run(cmd_sql, shell=True)
            st.success("âœ… RequÃªte SQL terminÃ©e !")

            # --- Conversion CSV -> Excel ---
            import csv
            csv_path = "C:/Users/4251352/Portail_outils/data/BHRe.csv"
            excel_path = "C:/Users/4251352/Portail_outils/data/BHRe.xlsx"
            df_csv = pd.read_csv(csv_path, sep=";")
            df_csv.to_excel(excel_path, index=False)
            Path(csv_path).unlink()  # Suppression du CSV
            st.success(f"âœ… Fichier Excel gÃ©nÃ©rÃ© â†’ {excel_path}")

            st.download_button(
                label="ðŸ’¾ TÃ©lÃ©charger BHRe.xlsx",
                data=open(excel_path, "rb").read(),
                file_name="BHRe.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            )

            progress.progress(100)

        except Exception as e:
            safe_show_exception(e)
