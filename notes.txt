mailer.py :
import smtplib
from email.message import EmailMessage
from pathlib import Path

def send_mail(mail_from, recipients, subject, body, attachments=None, cc=None):
    if attachments is None:
        attachments = []
    if cc is None:
        cc = []

    msg = EmailMessage()
    msg["From"] = mail_from
    msg["To"] = ", ".join(recipients)
    if cc:
        msg["Cc"] = ", ".join(cc)
    msg["Subject"] = subject
    msg["Reply-To"] = mail_from

    msg.set_content(body)

    for f in attachments:
        p = Path(f)
        msg.add_attachment(
            p.read_bytes(),
            maintype="application",
            subtype="octet-stream",
            filename=p.name
        )

    all_recipients = recipients + cc

    with smtplib.SMTP("smtp.aphp.fr", 25) as smtp:
        smtp.sendmail(mail_from, all_recipients, msg.as_string())

oracle_runner.py:
import subprocess
from pathlib import Path

def run_sqlplus(sql_file: Path, output_dir: Path, dsn: str, user: str, password: str, timeout: int = 300):
    output_dir.mkdir(parents=True, exist_ok=True)

    cmd = ["sqlplus", "-S", f"{user}/{password}@{dsn}", f"@{str(sql_file)}"]

    result = subprocess.run(
        cmd,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True,
        cwd=str(output_dir),
        timeout=timeout,
    )

    out = (result.stdout or "") + "\n" + (result.stderr or "")
    if result.returncode != 0:
        raise RuntimeError(f"SQL*Plus returncode={result.returncode}\n{out}")

    if "ORA-" in out or "SP2-" in out:
        raise RuntimeError(f"SQL*Plus a retourn√© une erreur\n{out}")

    return out
