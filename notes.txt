# --- Écriture Excel ---
def write_copy_with_values_to_patron(df, patron_path):
    from io import BytesIO
    wb = load_workbook(filename=str(patron_path))
    ws = wb.active

    # Header detection
    header_row = None
    for r in range(1, 30):
        values = [(ws.cell(row=r, column=c).value or "").strip().lower() for c in range(1, ws.max_column+1)]
        if "tim" in values and "site" in values:
            header_row = r
            break
    if not header_row:
        header_row = 1

    name_to_col = {str(ws.cell(row=header_row, column=c).value).strip(): c for c in range(1, ws.max_column+1)}

    col_map = {
        "TIM": name_to_col.get("TIM"),
        "SITE": name_to_col.get("SITE"),
        "UMA_HC": name_to_col.get("UMA HC"),
        "RUM_codes_mois": name_to_col.get("RUM codés mois"),
        "RUM_codes_cumulés": name_to_col.get("RUM codés cumulés"),
        "UMA_HDJ": name_to_col.get("UMA HDJ"),
        "DMU": name_to_col.get("DMU"),
        "RUM_rel_mois": name_to_col.get("RUM relancés mois"),
        "RUM_rel_cum": name_to_col.get("RUM relancés cumulés")
    }

    start = header_row + 1
    df_sorted = df.sort_values(by=["TIM", "SITE", "DMU", "UMA_HC", "UMA_HDJ"]).reset_index(drop=True)

    # Fill cells
    for idx, row in df_sorted.iterrows():
        excel_row = start + idx
        ws.cell(row=excel_row, column=col_map["TIM"]).value = row["TIM"]
        ws.cell(row=excel_row, column=col_map["SITE"]).value = row["SITE"]
        ws.cell(row=excel_row, column=col_map["DMU"]).value = row["DMU"]

        if row["UMA_HC"]:
            ws.cell(row=excel_row, column=col_map["UMA_HC"]).value = row["UMA_HC"]
            ws.cell(row=excel_row, column=col_map["RUM_codes_mois"]).value = int(row["RUM codés mois"]) if pd.notna(row["RUM codés mois"]) else None
            ws.cell(row=excel_row, column=col_map["RUM_codes_cumulés"]).value = int(row["RUM codés cumulés"]) if pd.notna(row["RUM codés cumulés"]) else None
        if row["UMA_HDJ"]:
            ws.cell(row=excel_row, column=col_map["UMA_HDJ"]).value = row["UMA_HDJ"]
            ws.cell(row=excel_row, column=col_map["RUM_rel_mois"]).value = int(row["RUM relancés mois"]) if pd.notna(row["RUM relancés mois"]) else None
            ws.cell(row=excel_row, column=col_map["RUM_rel_cum"]).value = int(row["RUM relancés cumulés"]) if pd.notna(row["RUM relancés cumulés"]) else None

    # Fusion et bordures horizontales
    merge_vertical_conditionnel(ws, col_map["TIM"], df_sorted["TIM"], start)
    merge_vertical_conditionnel(ws, col_map["SITE"], df_sorted["SITE"], start, group_col=df_sorted["TIM"])
    merge_vertical_conditionnel(ws, col_map["DMU"], df_sorted["DMU"], start, group_col=df_sorted["TIM"])
    draw_border_lines_for_tim_blocks(ws, start, df_sorted, 1, ws.max_column, site_col_idx=col_map["SITE"])

    # Bordures verticales pour toutes les colonnes
    thin = Side(border_style="thin", color="000000")
    for r in range(1, ws.max_row+1):
        for c in range(1, ws.max_column+1):
            cell = ws.cell(row=r, column=c)
            cell.border = Border(left=thin, right=thin, top=cell.border.top, bottom=cell.border.bottom)

    # Centrage uniquement TIM, SITE, DMU
    for idx, row in df_sorted.iterrows():
        excel_row = start + idx
        for c in [col_map["TIM"], col_map["SITE"], col_map["DMU"]]:
            ws.cell(row=excel_row, column=c).alignment = Alignment(horizontal="center", vertical="center")

    output = BytesIO()
    wb.save(output)
    output.seek(0)
    return output
