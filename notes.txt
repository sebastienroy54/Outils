import re
from pathlib import Path
from openpyxl import Workbook

def txt_to_excel(txt_file: Path, xlsx_file: Path):
    with txt_file.open(encoding="cp1252") as f:
        lines = [l.rstrip("\n") for l in f if l.strip()]

    header_idx = next(i for i,l in enumerate(lines) if re.match(r"^-{2,}", l.strip()))
    dash_line = lines[header_idx]

    columns, in_dash, start = [], False, 0
    for i, c in enumerate(dash_line + " "):
        if not in_dash and c == "-":
            in_dash, start = True, i
        elif in_dash and c != "-":
            in_dash = False
            columns.append((start, i))

    headers = [lines[header_idx-1][s:e].strip() for s,e in columns]

    wb = Workbook()
    ws = wb.active
    ws.append(headers)

    for line in lines[header_idx+1:]:
        if "sélectionnée" in line.lower():
            continue
        ws.append([line[s:e].strip() for s,e in columns])

    wb.save(xlsx_file)

