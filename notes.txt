DATE_TOL_DAYS = 2  # ±2 jours

def add_keys_with_delta(dates_dt: pd.Series, nip: pd.Series, ref: pd.Series):
    keys = []
    for d in range(-DATE_TOL_DAYS, DATE_TOL_DAYS + 1):
        shifted_dates = dates_dt + pd.Timedelta(days=d)
        keys.append(make_key(nip, shifted_dates, ref))
    return set(pd.concat(keys).dropna().unique())

base_dim_keys |= add_keys_with_delta(orbis_date_dt, orbis["IPP du patient"], orbis["Référence commerciale du DMI"])
base_dim_keys |= add_keys_with_delta(sag_date_dt, sag["NIP"], sag["Référence produit"])
base_dim_keys |= add_keys_with_delta(simpa_date_dt, simpa["NIP"], simpa["CDREFF"])
