# liste_tim.py
import pandas as pd
from pathlib import Path
import re
import json

PATRON_XLSX = Path("C:/Users/4251352/Portail_outils/data/tableau_rum_tim.xlsx")

def extract_uma_code_by_space(uma):
    """Retourne tout jusqu'au premier espace; si pas d'espace, retourne la chaîne entière (trim)."""
    if not isinstance(uma, str):
        return ""
    s = uma.strip()
    if s == "":
        return ""
    parts = s.split(" ", 1)
    return parts[0].strip()

def split_tims(cell):
    """Sépare un champ TIM sur / ; , | et nettoie les éléments."""
    if not isinstance(cell, str):
        return []
    cell = cell.strip()
    if cell == "" or cell.lower() in {"nan", "none"}:
        return []
    parts = re.split(r'[/;,|]+', cell)
    return [p.strip() for p in parts if p.strip()]

def normalize_dmu(raw):
    """Utilise directement la colonne DMU en gardant uniquement le code avant espace."""
    if not isinstance(raw, str):
        return ""
    s = raw.strip()
    if not s:
        return ""
    # DMU code = partie avant espace
    return s.split(" ", 1)[0].strip()

def build_tim_uma_dict(patron_path):
    df = pd.read_excel(patron_path, engine="openpyxl", dtype=str)

    df.columns = [c.strip() for c in df.columns]

    # Vérification des colonnes requises
    for col in ["Site", "UMA", "DMU"]:
        if col not in df.columns:
            raise KeyError(f"Colonne manquante : {col}")

    tim_ref_col = "TIM Référent" if "TIM Référent" in df.columns else None
    relance_col = "Relance" if "Relance" in df.columns else None

    result = {}  # tim -> site -> dmu -> set([umas])

    for _, row in df.iterrows():

        raw_uma = row.get("UMA", "")
        if not isinstance(raw_uma, str):
            continue
        raw_uma = raw_uma.strip()
        if raw_uma == "" or raw_uma.startswith("Total DMU"):
            continue

        uma_code = extract_uma_code_by_space(raw_uma)
        site = str(row.get("Site", "")).strip() or "UNKNOWN"

        # Nouveau : DMU direct !
        raw_dmu = row.get("DMU", "")
        dmu_code = normalize_dmu(raw_dmu)
        if dmu_code == "":
            continue  # pas de DMU → on ignore

        tims = []
        if tim_ref_col:
            tims += split_tims(row.get(tim_ref_col, ""))
        if relance_col:
            tims += split_tims(row.get(relance_col, ""))

        if not tims:
            continue

        for tim in tims:
            tim_norm = re.sub(r'\s+', ' ', tim).strip()
            if not tim_norm:
                continue

            # Construction dictionnaire 3 niveaux
            result.setdefault(tim_norm, {}).setdefault(site, {}).setdefault(dmu_code, set()).add(uma_code)

    # Conversion des sets en listes triées
    result_listified = {
        tim: {
            site: {dmu: sorted(list(umas)) for dmu, umas in dmus.items()}
            for site, dmus in sites.items()
        }
        for tim, sites in result.items()
    }

    return result_listified


d = build_tim_uma_dict(PATRON_XLSX)
for tim, sites in sorted(d.items()):
    print(f"{tim} = {json.dumps(sites, ensure_ascii=False)}")
