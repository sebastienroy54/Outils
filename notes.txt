import streamlit as st
import pandas as pd
from io import BytesIO
from openpyxl.styles import Font

def lire_fichier_excel(fichier):
    """Lit un fichier Excel et renvoie les métadonnées et le tableau nettoyé."""
    df = pd.read_excel(fichier, header=None)

    # Récupération des métadonnées
    resume_filtrage = df.iloc[3, 0]
    periode = str(df.iloc[4, 0])  # Contient la période (ex : "Période : 2025")
    filtres = df.iloc[5, 0]
    detail_valo = df.iloc[7, 0]

    # Extraction de l'année à partir de la ligne de période
    import re
    match = re.search(r"(\d{4})", periode)
    annee = match.group(1) if match else "XXXX"

    # Lecture du tableau de données à partir de la ligne 9 (index 8)
    data = pd.read_excel(fichier, header=8)
    data = data.iloc[:, :4]
    data.columns = ["Indicateur", "Valorisation", "Quantité", "Unité"]

    return annee, data, {
        "Résumé de filtrage": resume_filtrage,
        "Période": periode,
        "Filtres": filtres,
        "Détail valorisation": detail_valo
    }

def creer_tableau_comparatif(df_new, annee_new, df_old, annee_old):
    """Fusionne et compare deux DataFrames selon les indicateurs."""
    # Renommer les colonnes selon les années détectées
    df_new = df_new.rename(columns={
        "Valorisation": f"Valorisation {annee_new}",
        "Quantité": f"Quantité {annee_new}",
        "Unité": f"Unité {annee_new}"
    })
    df_old = df_old.rename(columns={
        "Valorisation": f"Valorisation {annee_old}",
        "Quantité": f"Quantité {annee_old}",
        "Unité": f"Unité {annee_old}"
    })

    # Fusion sur la colonne Indicateur
    df_merge = pd.merge(df_new, df_old, on="Indicateur", how="outer")

    # Calcul de la différence de valorisation
    df_merge[""] = ""  # colonne vide pour séparation visuelle
    df_merge[f"Écart Valorisation ({annee_new}-{annee_old})"] = (
        df_merge[f"Valorisation {annee_new}"] - df_merge[f"Valorisation {annee_old}"]
    )

    return df_merge

def generer_excel(df, annee_new, annee_old):
    """Crée un fichier Excel avec mise en forme : rouge si négatif."""
    output = BytesIO()
    with pd.ExcelWriter(output, engine='openpyxl') as writer:
        df.to_excel(writer, index=False, sheet_name="Comparatif")
        wb = writer.book
        ws = wb["Comparatif"]

        # Trouver la colonne de l'écart
        col_diff = None
        for i, col in enumerate(df.columns, start=1):
            if f"Écart Valorisation" in col:
                col_diff = i
                break

        # Mise en forme : texte rouge si négatif
        if col_diff:
            for row in range(2, len(df) + 2):  # Ignorer l’en-tête
                cell = ws.cell(row=row, column=col_diff)
                try:
                    val = float(cell.value)
                    if val < 0:
                        cell.font = Font(color="FF0000")  # rouge
                except:
                    pass

        # Ajuster largeur colonnes automatiquement
        for col in ws.columns:
            max_length = 0
            col_letter = col[0].column_letter
            for cell in col:
                if cell.value:
