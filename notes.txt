import pandas as pd
import streamlit as st
from io import BytesIO

def main():
    st.title("Croisement RAA")

    # Récupération du fichier
    agenda_file = st.file_uploader("Téléversez votre fichier Excel ici contenant les noms des praticiens", type=["xlsx"])
    ipp_file = st.file_uploader("Téléversez votre fichier Excel ici contenant des manquants", type=["xlsx"])

    if agenda_file and ipp_file:
        # Création d'un nouveau dataframe pour y mettre les colonnes avec les données voulues
        df_raw = pd.read_excel(ipp_file, header=None)
        colonnes = ['IPP', 'Date', 'Nom', 'Prénom', 'Unité', 'EDGAR']
        ipp_df = pd.DataFrame(df_raw.values, columns=colonnes)

        agenda = pd.read_excel(agenda_file)

        # Formatage des données
        for col in ['Patient', 'Acte EDGAR', 'IPP', 'EDGAR']:
            if col in agenda.columns:
                agenda[col] = agenda[col].astype(str).str.strip()
            if col in ipp_df.columns:
                ipp_df[col] = ipp_df[col].astype(str).str.strip()
        
        if 'Date RDV' in agenda.columns:
            agenda['Date RDV'] = pd.to_datetime(agenda['Date RDV'], errors='coerce')
        if 'Date' in ipp_df:
            ipp_df['Date'] = pd.to_datetime(ipp_df['Date'], errors='coerce')

        # Paramètres pour la fusion entre IPP et Patient
        merged = pd.merge(
            ipp_df,
            agenda,
            left_on='IPP',
            right_on='Patient',
            how='inner',
            suffixes=('_ipp', '_agenda')
        )

        # Condition sur les dates et les EDGAR
        condition = (
            (merged["Date RDV"] == merged['Date']) &
            (merged["Acte EDGAR"] == merged['EDGAR'])
        )

        resultat = merged.loc[condition, ['IPP', 'Nom', 'Prénom','NDA', 'Date', 'Agenda', 'EDGAR']]
        resultat['Date'] = pd.to_datetime(resultat['Date'], errors='coerce').dt.strftime('%d/%m/%Y')

        if not resultat.empty:
            output = BytesIO()
            with pd.ExcelWriter(output, engine='openpyxl') as writer:
                resultat.to_excel(writer, index=False, sheet_name='Résultats_manquants_60R')
            output.seek(0)

            st.download_button(
                label="Télécharger le fichier excel",
                data=output,
                file_name="Manquant_RAA.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            )
        else:
            st.info("Aucune correspondance trouvée selon les critères définis.")
