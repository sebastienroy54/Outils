        if submitted:
            if not user or not password:
                st.error("Veuillez renseigner vos identifiants Oracle.")
                return
            try:
                st.info("Test de connexion...")

                # ✅ EZCONNECT (à adapter au service/port réels)
                # Exemple: //host:1521/SERVICE
                dsn = f"//{TNS_MAP['CCH']}:1521/SIP1CCH"

                test_sql_path = SQL_DIR / "test_connexion.sql"  # celui que tu as déjà, avec whenever

                result = subprocess.run(
                    ["sqlplus", "-S", f"{user}/{password}@{dsn}", f"@{test_sql_path}"],
                    stdout=subprocess.PIPE,
                    stderr=subprocess.PIPE,
                    text=True,
                    timeout=10
                )

                if result.returncode == 0:
                    st.session_state.oracle_connected = True
                    st.session_state.logged_in = True
                    st.session_state.oracle_user = user
                    st.session_state.oracle_password = password
                    st.session_state.page = "rum"
                    st.rerun()
                else:
                    st.error("Connexion échouée. Vérifiez vos identifiants Oracle / host / service.")
                    st.code(result.stderr or result.stdout)

            except Exception as e:
                safe_show_exception(e)
