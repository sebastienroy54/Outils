def generer_excel(df, annee_new, annee_old):
    try:
        output = BytesIO()
        titre = f"Comparatif {annee_new} vs {annee_old}"

        # Convertir Quantité en entier
        for col in df.columns:
            if "Quantité" in col:
                df[col] = df[col].apply(lambda x: int(x) if pd.notna(x) else x)

        with pd.ExcelWriter(output, engine='openpyxl') as writer:
            df.to_excel(writer, index=False, sheet_name="Comparatif", startrow=1)
            wb = writer.book
            ws = wb["Comparatif"]

            # Titre ligne 1
            cell_titre = ws.cell(row=1, column=1)
            cell_titre.value = titre
            cell_titre.font = Font(size=14, bold=True)
            cell_titre.alignment = Alignment(horizontal="center")
            last_col_idx = df.shape[1]
            ws.merge_cells(start_row=1, start_column=1, end_row=1, end_column=last_col_idx)

            # Style header ligne 2
            header_fill = PatternFill(start_color="D9D9D9", end_color="D9D9D9", fill_type="solid")
            for c_idx in range(1, last_col_idx + 1):
                try:
                    cell = ws.cell(row=2, column=c_idx)
                    # Vérifier si ce n'est pas un MergedCell
                    if not hasattr(cell, "column_letter"):
                        continue
                    cell.font = Font(bold=True)
                    cell.alignment = Alignment(horizontal="center")
                    cell.fill = header_fill
                except AttributeError:
                    continue

            # Colonnes valorisation et écart
            valorisation_cols_idx = [i+1 for i, c in enumerate(df.columns) if "Valorisation" in c]
            ecart_col_idx = None
            for i, c in enumerate(df.columns, start=1):
                if "Écart Valorisation" in c:
                    ecart_col_idx = i
                    break
            if ecart_col_idx and ecart_col_idx not in valorisation_cols_idx:
                valorisation_cols_idx.append(ecart_col_idx)

            # Formater les cellules valorisation
            for row in range(3, len(df) + 3):
                for col_idx in valorisation_cols_idx:
                    cell = ws.cell(row=row, column=col_idx)
                    val = cell.value
                    if val is None or val == "":
                        cell.value = ""
                        continue
                    try:
                        val_float = float(val)
                        cell.value = format_valeur_monetaire_cell(val_float)
                        if val_float < 0:
                            cell.font = Font(color="FF0000")
                    except Exception:
                        pass

            # Ajustement largeur colonnes
            for idx in range(1, last_col_idx + 1):
                try:
                    col_letter = get_column_letter(idx)
                    max_length = 0
                    for r in range(1, len(df) + 3):
                        try:
                            cell = ws.cell(row=r, column=idx)
                            if not hasattr(cell, "column_letter"):
                                continue
                            if cell.value is not None:
                                max_length = max(max_length, len(str(cell.value)))
                        except AttributeError:
                            continue
                    ws.column_dimensions[col_letter].width = max(8, max_length + 2)
                except AttributeError:
                    continue

        output.seek(0)
        return output

    except Exception as e:
        raise RuntimeError("Impossible de générer le fichier Excel (vérifiez les données).") from e
