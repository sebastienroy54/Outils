# liste_tim.py
import pandas as pd
from pathlib import Path
import re
import json

PATRON_XLSX = Path("C:/Users/4251352/Portail_outils/data/tableau_rum_tim.xlsx")

def extract_uma_code_by_space(uma):
    """Retourne tout jusqu'au premier espace; si pas d'espace, retourne la chaîne entière (trim)."""
    if not isinstance(uma, str):
        return ""
    s = uma.strip()
    if s == "":
        return ""
    parts = s.split(" ", 1)
    return parts[0].strip()

def split_tims(cell):
    """Sépare un champ TIM sur / ; , | et nettoie les éléments."""
    if not isinstance(cell, str):
        return []
    # remplacer plusieurs espaces, puis split
    cell = cell.strip()
    if cell == "" or cell.lower() in {"nan", "none"}:
        return []
    parts = re.split(r'[/;,|]+', cell)
    parts = [p.strip() for p in parts if p and p.strip().lower() not in {"nan", "none"}]
    return parts

def build_tim_uma_dict(patron_path):
    df = pd.read_excel(patron_path, engine="openpyxl", dtype=str)

    # normaliser colonnes existantes
    df_cols = [c.strip() for c in df.columns]
    df.columns = df_cols

    # s'assurer des colonnes attendues (Site, UMA, TIM référent, Relance)
    for col in ["Site", "UMA"]:
        if col not in df.columns:
            raise KeyError(f"Colonne requise manquante dans le patron : '{col}'")

    # TIM columns may or may not exist
    tim_ref_col = "TIM référent" if "TIM référent" in df.columns else None
    relance_col = "Relance" if "Relance" in df.columns else None

    result = {}  # tim -> { site: set([uma_codes]) }

    for _, row in df.iterrows():
        raw_uma = row.get("UMA", "")
        if not isinstance(raw_uma, str):
            continue
        raw_uma = raw_uma.strip()
        if raw_uma == "" or raw_uma.startswith("Total DMU"):
            continue

        uma_code = extract_uma_code_by_space(raw_uma)
        site = str(row.get("Site", "")).strip() or "UNKNOWN"

        # collect TIMs from both columns
        tims = []
        if tim_ref_col:
            tims += split_tims(row.get(tim_ref_col, ""))
        if relance_col:
            tims += split_tims(row.get(relance_col, ""))

        # skip if no TIMs on this line
        if not tims:
            continue

        for tim in tims:
            if tim == "":
                continue
            # Normaliser nom : enlever espaces doublons
            tim_norm = re.sub(r'\s+', ' ', tim).strip()
            if tim_norm == "":
                continue

            if tim_norm not in result:
                result[tim_norm] = {}
            if site not in result[tim_norm]:
                result[tim_norm][site] = set()
            result[tim_norm][site].add(uma_code)

    # Convert sets to sorted lists for nicer output
    result_lists = {tim: {site: sorted(list(umas)) for site, umas in sites.items()} for tim, sites in result.items()}
    return result_lists

if __name__ == "__main__":
    d = build_tim_uma_dict(PATRON_XLSX)
    # affichage lisible
    for tim, sites in sorted(d.items()):
        print(f"{tim} = {sites}")
    # optionnel : dump json dans un fichier (décommente si besoin)
    # Path("tim_uma_mapping.json").write_text(json.dumps(d, ensure_ascii=False, indent=2), encoding="utf-8")
