def apply_uma_exceptions(df):
    """
    Exceptions UMA basées UNIQUEMENT sur les codes UMA,
    MAIS appliquées uniquement aux lignes concernées (TIM + SITE + UMA),
    et non à toutes les lignes d’un TIM.
    """

    print("\n======= DEBUG APPLY_UMA_EXCEPTIONS (corrigée) =======")

    # Aperçu utile
    print("UMA HC (codes) :", df["UMA_HC_code"].unique()[:20])
    print("UMA HDJ (codes):", df["UMA_HDJ_code"].unique()[:20])

    # ----------------------------------------------------------------------
    # 1️⃣  Exception : UMA 150 (HC) sur HTD
    # ----------------------------------------------------------------------
    mask_150_hc = (df["SITE"] == "HTD") & (df["UMA_HC_code"] == "150")
    if mask_150_hc.any():
        debug_rows = df.loc[mask_150_hc, ["TIM", "SITE", "UMA HC", "RUM codés mois"]]
        print("\n-- UMA 150 HC sur HTD (lignes trouvées) --")
        print(debug_rows)

        val_mois = df.loc[mask_150_hc, "RUM codés mois"].sum()
        val_cum = df.loc[mask_150_hc, "RUM codés cumulés"].sum()
        print(f"[150 HTD] Somme mois={val_mois}, cumul={val_cum}")

        # Cliniciens → affectation sur la LIGNE Cliniciens + UMA 150 uniquement
        mask_cliniciens_150 = mask_150_hc & (df["TIM"] == "Cliniciens")
        df.loc[mask_cliniciens_150, "RUM codés mois"] = val_mois
        df.loc[mask_cliniciens_150, "RUM codés cumulés"] = val_cum

        # Autres TIM → relancés uniquement sur leur ligne 150
        mask_other_tim_150 = mask_150_hc & (df["TIM"] != "Cliniciens")
        df.loc[mask_other_tim_150, "RUM relancés mois"] = df.loc[mask_other_tim_150, "RUM codés mois"]
        df.loc[mask_other_tim_150, "RUM relancés cumulés"] = df.loc[mask_other_tim_150, "RUM codés cumulés"]

        # On efface les codés uniquement sur les lignes concernées
        df.loc[mask_other_tim_150, ["RUM codés mois", "RUM codés cumulés"]] = np.nan

    # ----------------------------------------------------------------------
    # 2️⃣  Exception : UMA 040X (HC) sur CCH
    # ----------------------------------------------------------------------
    mask_040x = (df["SITE"] == "CCH") & (df["UMA_HC_code"] == "040X")
    if mask_040x.any():
        print("\n-- UMA 040X HC sur CCH --")
        print(df.loc[mask_040x, ["TIM", "SITE", "UMA HC", "RUM codés mois"]])

        df.loc[mask_040x, "RUM relancés mois"] = df.loc[mask_040x, "RUM codés mois"]
        df.loc[mask_040x, "RUM relancés cumulés"] = df.loc[mask_040x, "RUM codés cumulés"]

        df.loc[mask_040x, ["RUM codés mois", "RUM codés cumulés"]] = np.nan

    # ----------------------------------------------------------------------
    # 3️⃣  Exceptions HDJ → bascule dans CODÉS
    # ----------------------------------------------------------------------
    HDJ_SPECIAL = ["561C", "591C", "591J"]

    for code in HDJ_SPECIAL:
        mask_hdj_special = (df["SITE"] == "CCH") & (df["UMA_HDJ_code"] == code)

        if mask_hdj_special.any():
            print(f"\n-- UMA {code} HDJ → bascule CODÉS --")
            print(df.loc[mask_hdj_special, ["TIM", "SITE", "UMA HDJ", "RUM relancés mois"]])

            df.loc[mask_hdj_special, "RUM codés mois"] = df.loc[mask_hdj_special, "RUM relancés mois"]
            df.loc[mask_hdj_special, "RUM codés cumulés"] = df.loc[mask_hdj_special, "RUM relancés cumulés"]

            df.loc[mask_hdj_special, ["RUM relancés mois", "RUM relancés cumulés"]] = np.nan

    print("======= FIN APPLY_UMA_EXCEPTIONS =======\n")
    return df
