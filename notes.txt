import streamlit as st
import subprocess
import getpass
import os
import re
import pandas as pd

def main():
    st.title("Dashboard d'évolution des RUMs")

    annee1 = 2024
    annee2 = 2025

    user = st.text_input("Nom d'utilisateur")
    password = st.text_input("Mot de passe", type="password")
    tns_alias = st.text_input("TNS alias", value="SIP1CCH.WORLD")

    sql_file = r"C:\Users\4251352\Portail_outils\SQL\Requete_RUM.sql"

    if st.button("Actualiser le tableau"):
        if not user or not password:
            st.error("Merci de renseigner le nom d'utilisateur et le mot de passe")
        else:
            try:
                cmd = f'sqlplus {user}/{password}@{tns_alias} @{sql_file}'
                result = subprocess.run(
                    cmd,
                    shell=True,
                    capture_output=True,
                    text=True
                )

                if result.returncode != 0:
                    st.error("Erreur SQL*Plus : " + result.stderr)
                else:
                    output = result.stdout.strip()
                    st.text_area("Sortie brute SQLPlus", output[:1000])
                    df = parse_sqlplus_output(output)
                    if df is not None:
                        st.dataframe(df)
                    else:
                        st.warning("impossible de convertir la sortie SQLPlus en tableau")
            except Exception as e:
                st.error(f"Erreur lors de l'exécution : {e}")
    #csv_file = r"C:\Users\4251352\Portail_outils\dashboard.csv"
    #df = pd.read_csv(csv_file, sep=";")

def parse_sqlplus_output(output):
    lines = [line.strip() for line in output.splitlines() if line.strip()]
    if len(lines) < 2:
        return None
    try:
        data = [line.strip() for line in lines]
        df = pd.DataFrame(data[1:], columns=data[0])
        return df
    except Exception:
        return None
