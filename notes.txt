#!/usr/bin/env python3
"""
Compare le FORMAT des lignes de deux CSV (séparateur ;)
sans comparer les valeurs exactes
"""

import csv
import re
import itertools
import sys

FILE_1 = "SX273302.csv"
FILE_2 = "SX272586.csv"
MAX_DIFFS = 50


DATE_RE = re.compile(r"""
    ^
    (\d{4}-\d{2}-\d{2})     # YYYY-MM-DD
    |
    (\d{2}/\d{2}/\d{4})    # DD/MM/YYYY
    $
""", re.VERBOSE)


def cell_type(value: str) -> str:
    if value is None or value == "":
        return "EMPTY"
    if DATE_RE.match(value):
        return "DATE"
    try:
        float(value.replace(",", "."))
        return "NUM"
    except ValueError:
        return "TEXT"


def read_csv(path):
    with open(path, "r", encoding="utf-8", errors="replace", newline="") as f:
        return list(csv.reader(f, delimiter=";"))


def compare_format(f1, f2, max_diffs=50):
    rows1 = read_csv(f1)
    rows2 = read_csv(f2)

    diffs = 0

    for line_no, (r1, r2) in enumerate(
        itertools.zip_longest(rows1, rows2, fillvalue=None), start=1
    ):
        if r1 is None or r2 is None:
            print(f"\n[Ligne {line_no}] Présente dans un fichier mais pas l'autre")
            diffs += 1
            continue

        if len(r1) != len(r2):
            print(f"\n[Ligne {line_no}] Nombre de colonnes différent")
            print(f"  {f1}: {len(r1)} colonnes")
            print(f"  {f2}: {len(r2)} colonnes")
            diffs += 1
            continue

        for col_no, (c1, c2) in enumerate(zip(r1, r2), start=1):
            t1 = cell_type(c1)
            t2 = cell_type(c2)

            if t1 != t2:
                diffs += 1
                if diffs > max_diffs:
                    continue

                print(f"\n[Ligne {line_no}, Colonne {col_no}] FORMAT DIFFÉRENT")
                print(f"  {f1}: {t1}")
                print(f"  {f2}: {t2}")

    if diffs == 0:
        print("✅ Formats compatibles sur toutes les lignes.")
        return 0

    print(f"\n❌ {diffs} différence(s) de format détectée(s).")
    return 1


if __name__ == "__main__":
    sys.exit(compare_format(FILE_1, FILE_2, MAX_DIFFS))
