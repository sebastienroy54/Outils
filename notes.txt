# Oracle 10.2 impose une glibc ancienne
FROM debian:9-slim

# --------------------------------------------------
# Dépendances système
# --------------------------------------------------
RUN apt-get update && apt-get install -y \
    libaio1 \
    unzip \
    python3 \
    python3-pip \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# --------------------------------------------------
# Oracle Instant Client 10.2 + SQL*Plus
# --------------------------------------------------
WORKDIR /opt/oracle

# ZIP fournis dans le projet (contexte Docker)
COPY instantclient-basic-linux-x64-10.2.0.5.0.zip .
COPY instantclient-sqlplus-linux-x64-10.2.0.5.0.zip .

RUN unzip instantclient-basic-linux-x64-10.2.0.5.0.zip && \
    unzip instantclient-sqlplus-linux-x64-10.2.0.5.0.zip && \
    rm -f *.zip && \
    ln -sf instantclient_10_2/libclntsh.so.10.1 instantclient_10_2/libclntsh.so && \
    ln -sf instantclient_10_2/libocci.so.10.1 instantclient_10_2/libocci.so

# --------------------------------------------------
# Variables Oracle (dans le conteneur uniquement)
# --------------------------------------------------
ENV ORACLE_HOME=/opt/oracle/instantclient_10_2
ENV LD_LIBRARY_PATH=/opt/oracle/instantclient_10_2
ENV PATH=/opt/oracle/instantclient_10_2:$PATH

# --------------------------------------------------
# Application Python
# --------------------------------------------------
WORKDIR /app

COPY requirements.txt .
RUN pip3 install --no-cache-dir -r requirements.txt

COPY . .

# --------------------------------------------------
# Streamlit
# --------------------------------------------------
EXPOSE 8501
CMD ["streamlit", "run", "app.py", "--server.address=0.0.0.0"]
