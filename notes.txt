# Valeur a modifier pour debug de code
DEBUG_CONNEXION = False


def rerun():
    try:
        st.rerun()
    except AttributeError:
        st.experimental_rerun()


def dbg_append(line: str):
    """Ajoute une ligne au log uniquement si DEBUG_CONNEXION=True."""
    if not DEBUG_CONNEXION:
        return
    st.session_state["debug_log"] = st.session_state.get("debug_log", "") + line + "\n"


def dbg_state(label: str):
    """Trace un petit √©tat session_state (uniquement en debug)."""
    if not DEBUG_CONNEXION:
        return
    keys = ["logged_in", "oracle_connected", "page", "oracle_user", "show_exception", "last_exception_str"]
    dbg_append(f"\n--- STATE {label} ---")
    for k in keys:
        dbg_append(f"{k} = {st.session_state.get(k, '(absent)')}")


def dbg_show(key_suffix=""):
    """Affiche le debug + bouton clear (uniquement en debug)."""
    if not DEBUG_CONNEXION:
        return
    if st.session_state.get("debug_log"):
        st.subheader("DEBUG connexion (persistant)")
        st.code(st.session_state.get("debug_log", ""))
        if st.button("Effacer debug", key=f"debug_clear_btn{key_suffix}"):
            st.session_state["debug_log"] = ""
            rerun()


def safe_show_exception(e):
    """Affichage erreur + d√©tails techniques (uniquement en debug pour √©viter widgets en prod)."""
    st.error("Une erreur est survenue. V√©rifiez vos fichiers ou contactez le support.")
    if not DEBUG_CONNEXION:
        # En mode normal: pas de checkbox (√©vite effets de bord / reruns)
        return

    st.session_state["last_exception_str"] = str(e)
    show = st.checkbox("Afficher d√©tails techniques", key="show_exception_checkbox")
    if show:
        st.code(st.session_state.get("last_exception_str", ""))


def page_connexion():
    st.title("Connexion Oracle")

    # En debug seulement : afficher la derni√®re exception persist√©e
    if DEBUG_CONNEXION and st.session_state.get("last_conn_exception"):
        st.warning("Derni√®re exception connexion (persist√©e)")
        st.code(st.session_state["last_conn_exception"])
        if st.button("Effacer derni√®re exception", key="clear_last_conn_exception"):
            st.session_state["last_conn_exception"] = ""
            rerun()

    # Un seul dbg_show par run (en haut de page)
    dbg_show("_conn")

    if not st.session_state.logged_in:
        with st.form("connexion"):
            st.subheader("Connexion Oracle")
            user = st.text_input("üë§ Nom d'utilisateur Oracle :", key="conn_user")
            password = st.text_input("üîë Mot de passe :", type="password", key="conn_pwd")
            submitted = st.form_submit_button("üöÄ Se connecter")

        if submitted:
            # reset flags
            st.session_state.logged_in = False
            st.session_state.oracle_connected = False
            st.session_state.page = "connexion"

            # reset debug log seulement si debug
            if DEBUG_CONNEXION:
                st.session_state["debug_log"] = ""

            if not user or not password:
                st.error("Veuillez renseigner vos identifiants Oracle.")
                return

            try:
                st.info("Test de connexion...")

                dsn = TNS_MAP["CCH"]
                test_sql_path = SQL_DIR / "test_connexion.sql"

                dbg_append("=== Tentative de connexion Oracle ===")
                dbg_append(f"User: {user}")
                dbg_append(f"DSN: {dsn}")
                dbg_append(f"test_sql_path: {test_sql_path}")
                dbg_append(f"test_sql_exists: {test_sql_path.exists()}")

                if DEBUG_CONNEXION:
                    # Infos environnement (utile en Docker)
                    try:
                        w = subprocess.run(["which", "sqlplus"], stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
                        dbg_append(f"which sqlplus: {w.stdout.strip()} {w.stderr.strip()}")
                    except Exception as e:
                        dbg_append(f"which sqlplus failed: {e}")

                    dbg_append(
                        f"PATH: {subprocess.run(['sh','-lc','echo $PATH'], stdout=subprocess.PIPE, text=True).stdout.strip()}"
                    )
                    dbg_append(
                        f"ORACLE_HOME: {subprocess.run(['sh','-lc','echo $ORACLE_HOME'], stdout=subprocess.PIPE, text=True).stdout.strip()}"
                    )
                    dbg_append(
                        f"LD_LIBRARY_PATH: {subprocess.run(['sh','-lc','echo $LD_LIBRARY_PATH'], stdout=subprocess.PIPE, text=True).stdout.strip()}"
                    )
                    dbg_append("Command (password masked):")
                    dbg_append(f"sqlplus -S {user}/******@{dsn} @{test_sql_path}")

                result = subprocess.run(
                    ["sqlplus", "-S", f"{user}/{password}@{dsn}", f"@{test_sql_path}"],
                    stdout=subprocess.PIPE,
                    stderr=subprocess.PIPE,
                    text=True,
                    timeout=10
                )

                dbg_append(f"returncode: {result.returncode}")
                dbg_append("---- STDOUT ----")
                dbg_append(result.stdout or "(vide)")
                dbg_append("---- STDERR ----")
                dbg_append(result.stderr or "(vide)")

                if result.returncode == 0:
                    dbg_append(">>> SUCCESS branch entered (returncode==0)")
                    dbg_state("AVANT set session")

                    st.session_state.oracle_connected = True
                    st.session_state.logged_in = True
                    st.session_state.oracle_user = user
                    st.session_state.oracle_password = password
                    st.session_state.page = "rum"

                    dbg_state("APRES set session")

                    st.success("Connexion OK.")
                    if DEBUG_CONNEXION:
                        st.write("MARKER: avant rerun()")

                    rerun()
                else:
                    st.error("Connexion √©chou√©e. V√©rifiez vos identifiants Oracle.")
                    # Afficher stdout/stderr m√™me hors debug (utile)
                    st.code(result.stderr or result.stdout)

            except Exception as e:
                if DEBUG_CONNEXION:
                    import traceback
                    tb = traceback.format_exc()
                    st.session_state["last_conn_exception"] = f"{repr(e)}\n\n{tb}"
                    st.error("EXCEPTION dans page_connexion() (debug)")
                    st.code(tb)
                    dbg_state("ETAT AU MOMENT EXCEPTION")
                    # Ne pas st.stop() en mode normal, mais en debug √ßa aide √† figer l'√©cran
                    st.stop()
                else:
                    # Mode normal : message simple
                    safe_show_exception(e)
                    return
    else:
        st.success("Connexion active.")
        if st.button("‚û° Aller √† la page RUM", key="go_rum"):
            st.session_state.page = "rum"
            rerun()


def ensure_session_vars():
    # Ne touche pas au log si pas en debug (√©vite pollution)
    if DEBUG_CONNEXION:
        st.session_state["debug_log"] = st.session_state.get("debug_log", "")
        dbg_append("\n=== ensure_session_vars() called ===")
        dbg_state("DANS ensure_session_vars (avant defaults)")

    defaults = {
        "logged_in": False,
        "oracle_connected": False,
        "page": "connexion",
        "oracle_user": "",
        "oracle_password": "",
        "last_exception_str": "",
        "show_exception": False,
        # en debug seulement, mais pas g√™nant si pr√©sent
        "last_conn_exception": "",
        "run_count": 0,
    }
    for k, v in defaults.items():
        if k not in st.session_state:
            st.session_state[k] = v


def main():
    st.title("Tableau d'exhaustivit√© des RUMs par TIM")
    ensure_session_vars()

    if DEBUG_CONNEXION:
        st.session_state.run_count = st.session_state.get("run_count", 0) + 1
        dbg_append(f"\n=== RUN #{st.session_state.run_count} {datetime.now().isoformat()} ===")
        dbg_append(
            f"=== MAIN routing: page={st.session_state.get('page')} "
            f"logged_in={st.session_state.get('logged_in')} "
            f"oracle_connected={st.session_state.get('oracle_connected')} ==="
        )
        dbg_show("_main")

    if st.session_state.page == "connexion":
        page_connexion()
    elif st.session_state.page == "rum":
        if not st.session_state.logged_in:
            st.session_state.page = "connexion"
            rerun()
        page_rum()
    else:
        st.session_state.page = "connexion"
        rerun()


if __name__ == "__main__":
    main()
