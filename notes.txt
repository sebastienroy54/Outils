import streamlit as st
import pandas as pd

def lire_fichier_excel(fichier):
    """Lit un fichier Excel et renvoie les m√©tadonn√©es et le tableau nettoy√©."""
    df = pd.read_excel(fichier, header=None)

    # R√©cup√©ration des m√©tadonn√©es
    resume_filtrage = df.iloc[3, 0]
    periode = str(df.iloc[4, 0])  # Contient la p√©riode (ex : "P√©riode : 2025")
    filtres = df.iloc[5, 0]
    detail_valo = df.iloc[7, 0]

    # Extraction de l'ann√©e √† partir de la ligne de p√©riode
    import re
    match = re.search(r"(\d{4})", periode)
    annee = match.group(1) if match else "XXXX"

    # Le vrai tableau commence √† la ligne 8 (index 8 -> ligne 9 Excel)
    data = pd.read_excel(fichier, header=8)

    # Nettoyage des colonnes
    data = data.iloc[:, :4]
    data.columns = ["Indicateur", "Valorisation", "Quantit√©", "Unit√©"]

    return annee, data, {
        "R√©sum√© de filtrage": resume_filtrage,
        "P√©riode": periode,
        "Filtres": filtres,
        "D√©tail valorisation": detail_valo
    }

def creer_tableau_comparatif(df_new, annee_new, df_old, annee_old):
    """Fusionne et compare deux DataFrames selon l'indicateur."""
    # Renommer les colonnes selon les ann√©es d√©tect√©es
    df_new = df_new.rename(columns={
        "Valorisation": f"Valorisation {annee_new}",
        "Quantit√©": f"Quantit√© {annee_new}",
        "Unit√©": f"Unit√© {annee_new}"
    })
    df_old = df_old.rename(columns={
        "Valorisation": f"Valorisation {annee_old}",
        "Quantit√©": f"Quantit√© {annee_old}",
        "Unit√©": f"Unit√© {annee_old}"
    })

    # Fusion sur la colonne Indicateur
    df_merge = pd.merge(df_new, df_old, on="Indicateur", how="outer")

    # Calcul de la diff√©rence
    df_merge[""] = ""  # colonne vide
    df_merge[f"√âcart Valorisation ({annee_new}-{annee_old})"] = (
        df_merge[f"Valorisation {annee_new}"] - df_merge[f"Valorisation {annee_old}"]
    )

    return df_merge

def afficher_tableau_colore(df, annee_new, annee_old):
    """Applique une mise en forme conditionnelle au DataFrame Streamlit."""
    def color_neg(v):
        color = 'red' if isinstance(v, (int, float)) and v < 0 else 'black'
        return f'color: {color}'

    st.dataframe(
        df.style.applymap(color_neg, subset=[f"√âcart Valorisation ({annee_new}-{annee_old})"])
    )

def main():
    st.title("üìä Comparateur de Valorisation T2A")

    st.write("### üóÇÔ∏è Importez les deux fichiers Excel")
    fichier1 = st.file_uploader("Fichier r√©cent (ex: 2025)", type=["xlsx"], key="file1")
    fichier2 = st.file_uploader("Fichier ancien (ex: 2024)", type=["xlsx"], key="file2")

    if fichier1 and fichier2:
        annee1, df1, meta1 = lire_fichier_excel(fichier1)
        annee2, df2, meta2 = lire_fichier_excel(fichier2)

        # V√©rifie l'ordre chronologique et swap si besoin
        if int(annee1) < int(annee2):
            st.warning(f"‚ö†Ô∏è Inversion d√©tect√©e : le fichier {annee1} semble plus ancien que {annee2}. Inversion automatique.")
            df1, df2 = df2, df1
            annee1, annee2 = annee2, annee1

        st.write("### üßæ M√©tadonn√©es")
        st.write(f"**P√©riode {annee1} :** {meta1['P√©riode']}")
        st.write(f"**P√©riode {annee2} :** {meta2['P√©riode']}")

        st.write("### üìà Tableau comparatif")
        df_comparatif = creer_tableau_comparatif(df1, annee1, df2, annee2)
        afficher_tableau_colore(df_comparatif, annee1, annee2)

        # Option de t√©l√©chargement
        csv = df_comparatif.to_csv(index=False).encode('utf-8')
        st.download_button("üíæ T√©l√©charger le comparatif (CSV)", data=csv, file_name="comparatif_valo.csv", mime="text/csv")

if __name__ == "__main__":
    main()
