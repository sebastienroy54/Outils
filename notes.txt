def trouver_feuille_avec_colonnes(fichier, colonnes_attendues, max_scan=50):
    import openpyxl
    wb = openpyxl.load_workbook(fichier, data_only=True)
    st.write("DEBUG: sheetnames trouvées ->", wb.sheetnames)

    def correspond(cell, attendu):
        c = normaliser_texte(cell)
        a = normaliser_texte(attendu)
        if c == a:
            return True
        if a == "ipp" and re.sub(r"[^a-z]", "", c) == "ipp":
            return True
        if a == "prénom" and c.replace("é","e") == "prenom":
            return True
        return False

    # Parcours des feuilles
    for sheetname in wb.sheetnames:
        st.write(f"\n--- FEUILLE: {sheetname} ---")
        # IMPORTANT: remettre le curseur en début pour que pandas puisse relire l'uploader
        try:
            fichier.seek(0)
        except Exception:
            pass

        df = pd.read_excel(fichier, sheet_name=sheetname, header=None, dtype=str, engine="openpyxl")
        st.write(f"Aperçu brut ({sheetname}) shape={df.shape}:")
        st.dataframe(df.head(20))

        # Scanner les premières lignes
        nscan = min(len(df), max_scan)
        st.write(f"DEBUG: je scanne jusqu'à {nscan} lignes dans la feuille {sheetname}")
        for i in range(nscan):
            row = df.iloc[i].tolist()
            row_norm = [normaliser_texte(x) for x in row]
            non_empty = [x for x in row if str(x).strip() not in ["", "None", "nan"]]
            contains_equal = any("=" in str(x) for x in row)
            long_cells = any(len(str(x)) > 25 for x in non_empty)

            # compter les correspondances
            match_count = 0
            matches = {}
            for attendu in colonnes_attendues:
                ok = any(correspond(x, attendu) for x in row)
                if ok:
                    match_count += 1
                matches[attendu] = ok

            st.write({
                "sheet": sheetname,
                "line_index": i,
                "raw_row": row,
                "normalized_row": row_norm,
                "non_empty_count": len(non_empty),
                "contains_equal": contains_equal,
                "has_long_cells": long_cells,
                "match_count": match_count,
                "matches": matches
            })

            # conditions initiales de notre detection (gardées pour debug)
            if contains_equal:
                st.write(f"  -> skip ligne {i} (contient '=')")
                continue
            if len(non_empty) < 3:
                st.write(f"  -> skip ligne {i} (trop peu de cellules non vides: {len(non_empty)})")
                continue
            if long_cells:
                st.write(f"  -> skip ligne {i} (cellule trop longue)")
                continue
            if match_count >= 2:
                st.write(f"  -> POSSIBLE HEADER trouvé en ligne {i} de la feuille {sheetname}")
                # retélécharger proprement avec header fixé
                try:
                    fichier.seek(0)
                except Exception:
                    pass
                df_final = pd.read_excel(fichier, sheet_name=sheetname, header=i, dtype=str, engine="openpyxl")
                st.write("Aperçu avec header fixé :")
                st.dataframe(df_final.head(10))
                return df_final, sheetname, i

    raise ValueError(f"Aucune feuille ne contient les colonnes {colonnes_attendues} (diagnostic terminé)")
