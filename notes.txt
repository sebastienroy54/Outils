import streamlit as st
import pandas as pd
from io import BytesIO
from openpyxl.styles import Font, Alignment
from openpyxl import Workbook

# -----------------------
# Helpers
# -----------------------
def safe_show_exception(e):
    """Affiche un message utilisateur simple et propose d'afficher le d√©tail technique."""
    st.error("Une erreur est survenue pendant le traitement. V√©rifiez vos fichiers ou contactez le support.")
    if st.checkbox("Afficher les d√©tails techniques (pour un d√©veloppeur)"):
        st.exception(e)

def lire_fichier_excel(fichier, widget_label="fichier"):
    """Lit un fichier Excel et renvoie (annee, data, meta)."""
    try:
        df = pd.read_excel(fichier, header=None)
    except Exception as e:
        raise RuntimeError(f"Impossible de lire le {widget_label} : fichier non lisible.") from e

    try:
        resume_filtrage = df.iloc[3, 0]
        periode = str(df.iloc[4, 0])
        filtres = df.iloc[5, 0]
        detail_valo = df.iloc[7, 0]

        import re
        match = re.search(r"(\d{4})", periode)
        annee = match.group(1) if match else "XXXX"

        data = pd.read_excel(fichier, header=8)
        data = data.iloc[:, :4]
        data.columns = ["Indicateur", "Valorisation", "Quantit√©", "Unit√©"]
    except Exception as e:
        raise RuntimeError("Le format du fichier Excel ne correspond pas au mod√®le attendu.") from e

    return annee, data, {
        "R√©sum√© de filtrage": resume_filtrage,
        "P√©riode": periode,
        "Filtres": filtres,
        "D√©tail valorisation": detail_valo
    }

def creer_tableau_comparatif(df_new, annee_new, df_old, annee_old):
    """Fusionne en gardant l'ordre df_new (le plus r√©cent)."""
    try:
        df_new = df_new.rename(columns={
            "Valorisation": f"Valorisation {annee_new}",
            "Quantit√©": f"Quantit√© {annee_new}",
            "Unit√©": f"Unit√© {annee_new}"
        })
        df_old = df_old.rename(columns={
            "Valorisation": f"Valorisation {annee_old}",
            "Quantit√©": f"Quantit√© {annee_old}",
            "Unit√©": f"Unit√© {annee_old}"
        })

        df_merge = df_new.merge(df_old, on="Indicateur", how="left", sort=False)
        df_merge[f"√âcart Valorisation ({annee_new}-{annee_old})"] = (
            df_merge[f"Valorisation {annee_new}"] - df_merge[f"Valorisation {annee_old}"]
        )
    except Exception as e:
        raise RuntimeError("Erreur lors de la cr√©ation du tableau comparatif.") from e

    return df_merge

def format_valeur_monetaire(val):
    """Format 1 234 567 ‚Ç¨ ou vide si NaN."""
    try:
        if pd.isna(val) or val == "":
            return ""
        v = float(val)
        return f"{v:,.0f}".replace(",", " ") + " ‚Ç¨"
    except:
        return val

def generer_excel(df, annee_new, annee_old):
    """G√©n√®re un fichier Excel stylis√© et renvoie BytesIO."""
    try:
        output = BytesIO()
        wb = Workbook()
        ws = wb.active
        ws.title = "Comparatif"

        # Titre
        titre = f"Comparatif {annee_new} vs {annee_old}"
        ws.cell(row=1, column=1, value=titre)
        ws.cell(row=1, column=1).font = Font(size=14, bold=True)
        ws.cell(row=1, column=1).alignment = Alignment(horizontal="center")

        # √âcrire le DataFrame en partant de la ligne 2
        df_to_write = df.copy()

        # Quantit√© en entier
        for col in df_to_write.columns:
            if "Quantit√©" in col:
                df_to_write[col] = df_to_write[col].apply(lambda x: int(x) if pd.notna(x) else x)

        # Formater Valorisation et √âcart
        for col in df_to_write.columns:
            if "Valorisation" in col or "√âcart Valorisation" in col:
                df_to_write[col] = df_to_write[col].apply(lambda x: format_valeur_monetaire(x))

        # √âcrire les en-t√™tes
        for j, col in enumerate(df_to_write.columns, start=1):
            ws.cell(row=2, column=j, value=col).font = Font(bold=True)

        # √âcrire les valeurs
        for i, row in enumerate(df_to_write.values, start=3):
            for j, val in enumerate(row, start=1):
                cell = ws.cell(row=i, column=j, value=val)
                if isinstance(val, str) and "‚Ç¨" in val:
                    try:
                        num = float(val.replace("‚Ç¨","").replace(" ",""))
                        if num < 0:
                            cell.font = Font(color="FF0000")
                    except:
                        pass

        wb.save(output)
        output.seek(0)
        return output

    except Exception as e:
        raise RuntimeError("Impossible de g√©n√©rer le fichier Excel.") from e

def afficher_tableau_colore(df, annee_new, annee_old):
    """Affiche le tableau dans Streamlit."""
    try:
        valorisation_cols = [c for c in df.columns if "Valorisation" in c or "√âcart Valorisation" in c]
        df_styled = df.copy()

        for col in valorisation_cols:
            df_styled[col] = df_styled[col].apply(
                lambda v: format_valeur_monetaire(float(v)) if pd.notna(v) and v != "" else ""
            )

        def color_neg(v):
            try:
                val = float(str(v).replace("‚Ç¨", "").replace(" ", "").replace(",", "."))
                return 'color: red' if val < 0 else ''
            except:
                return ''

        st.markdown(f"### üìä Comparatif {annee_new} vs {annee_old}")
        st.dataframe(df_styled.style.applymap(color_neg, subset=valorisation_cols))

    except Exception as e:
        raise RuntimeError("Erreur lors de l'affichage du tableau.") from e

# -----------------------
# main()
# -----------------------
def main():
    st.title("üí∂ Comparateur de Valorisation T2A")
    st.write("### üóÇÔ∏è Importez les deux fichiers Excel")

    fichier1 = st.file_uploader("Fichier r√©cent (ex: 2025)", type=["xlsx"], key="file1")
    fichier2 = st.file_uploader("Fichier ancien (ex: 2024)", type=["xlsx"], key="file2")

    if not (fichier1 and fichier2):
        st.info("Veuillez uploader les deux fichiers pour comparer.")
        return

    if not st.button("Lancer la comparaison"):
        return

    try:
        annee1, df1, meta1 = lire_fichier_excel(fichier1, "premier fichier")
        annee2, df2, meta2 = lire_fichier_excel(fichier2, "deuxi√®me fichier")

        # Swap si ordre invers√©
        try:
            if int(annee1) < int(annee2):
                st.info("Inversion d√©tect√©e : les fichiers seront r√©ordonn√©s automatiquement.")
                annee1, annee2 = annee2, annee1
                df1, df2 = df2, df1
        except:
            st.warning("Impossible de d√©terminer l'ordre des ann√©es automatiquement.")

        st.write(f"**P√©riode {annee1}:** {meta1.get('P√©riode','')}")
        st.write(f"**P√©riode {annee2}:** {meta2.get('P√©riode','')}")

        df_comparatif = creer_tableau_comparatif(df1, annee1, df2, annee2)
        afficher_tableau_colore(df_comparatif, annee1, annee2)

        excel_data = generer_excel(df_comparatif, annee1, annee2)
        st.download_button(
            label="üíæ T√©l√©charger le comparatif (Excel)",
            data=excel_data,
            file_name=f"Comparatif_{annee1}_{annee2}.xlsx",
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )

    except Exception as e:
        safe_show_exception(e)

if __name__ == "__main__":
    main()
