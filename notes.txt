SET LINESIZE 32767
SET HEADING ON
SET COLSEP ";"
SET PAGESIZE 0
SET FEEDBACK OFF
SET TRIMSPOOL ON
SET WRAP OFF
SET TERMOUT OFF

SPOOL resultat_doublons.csv

SELECT DISTINCT
  S1.KYNOIP AS IPP,
  E1.KYNODA AS KYNODA1,
  E1.CDURM_P AS UMA1,
  E1.D8EEUE AS DATEE1,
  E1.D8SOUE AS DATES1,
  E2.KYNODA AS KYNODA2,
  E2.CDURM_P AS UMA2,
  E2.D8EEUE AS DATEE2,
  E2.D8SOUE AS DATES2,
  CASE 
    WHEN E1.CDURM_P = E2.CDURM_P 
         AND E1.D8EEUE = E2.D8EEUE 
         AND E1.D8SOUE = E2.D8SOUE 
      THEN 'VRAI_DOUBLON'
    WHEN E1.CDURM_P <> E2.CDURM_P 
         AND E1.D8EEUE = E2.D8EEUE 
         AND E1.D8SOUE = E2.D8SOUE 
      THEN 'DOUBLON_0_NUIT'
    WHEN E1.CDURM_P <> E2.CDURM_P 
         AND E1.D8SOUE = E2.D8EEUE 
      THEN 'CONTIGUS'
    WHEN E1.CDURM_P <> E2.CDURM_P 
         AND E1.D8SOUE BETWEEN E2.D8EEUE + 1 AND E2.D8SOUE 
      THEN 'CHEVAUCHEMENT'
    ELSE NULL 
  END AS TYPE_RELATION
FROM EPI E1, EPI E2, SDO S1, SDO S2
WHERE E1.KYNODA = S1.KYNODA
  AND E2.KYNODA = S2.KYNODA
  AND S1.KYNOIP = S2.KYNOIP
  AND E1.KYNODA <> E2.KYNODA
  AND E1.CDURM_P IS NOT NULL
  AND E2.CDURM_P IS NOT NULL
  AND E1.CDURM_P <> ''
  AND E2.CDURM_P <> ''
  AND E1.D8EEUE >= TO_DATE('2024-01-01','YYYY-MM-DD')
  AND E1.D8EEUE < TO_DATE('2026-01-01','YYYY-MM-DD')
  AND E2.D8EEUE >= TO_DATE('2024-01-01','YYYY-MM-DD')
  AND E2.D8EEUE < TO_DATE('2026-01-01','YYYY-MM-DD')
  AND (
      (E1.CDURM_P = E2.CDURM_P AND E1.D8EEUE = E2.D8EEUE AND E1.D8SOUE = E2.D8SOUE)
   OR (E1.CDURM_P <> E2.CDURM_P AND E1.D8EEUE = E2.D8EEUE AND E1.D8SOUE = E2.D8SOUE)
   OR (E1.CDURM_P <> E2.CDURM_P AND E1.D8SOUE = E2.D8EEUE)
   OR (E1.CDURM_P <> E2.CDURM_P AND E1.D8SOUE BETWEEN E2.D8EEUE + 1 AND E2.D8SOUE)
  );

SPOOL OFF
EXIT;

import subprocess
import getpass
import os
import pandas as pd

user = input("Veuillez entrer le nom d'utilisateur : ")
password = getpass.getpass("Mot de passe : ")
tns_alias = "SIP1CCH.WORLD"

sql_file = "contigus.sql"
input_csv = "resultat_doublons.csv"   # nom du fichier produit par SQLPlus
output_excel = "doublons.xlsx"

print("\nExécution de la requête SQL, veuillez patienter...")
cmd = f'sqlplus -s {user}/{password}@{tns_alias} @{sql_file}'
subprocess.run(cmd, shell=True, check=True)
print("Requête terminée. Lecture du fichier CSV...")

if not os.path.exists(input_csv):
    raise FileNotFoundError(f"Le fichier {input_csv} est introuvable.")

df = pd.read_csv(input_csv, sep=';', skip_blank_lines=True)

# Nettoyage des colonnes
df.columns = [col.strip().upper() for col in df.columns]
df = df.applymap(lambda x: x.strip() if isinstance(x, str) else x)

if "TYPE_RELATION" not in df.columns:
    print("Champ TYPE_RELATION manquant dans le CSV."
          "Aucune classification détectée, vérifie la requête SQL.")
else:
    groupes = df["TYPE_RELATION"].dropna().unique()

    if len(groupes) == 0:
        print("Aucun type de relation trouvé dans le fichier CSV.")
    else:
        with pd.ExcelWriter(output_excel, engine="xlsxwriter") as writer:
            for groupe in groupes:
                subset = df[df["TYPE_RELATION"] == groupe]
                # Limite à 31 caractères pour le nom d'onglet Excel
                sheet_name = re.sub(r'[^A-Za-z0-9_]', '_', groupe)[:31]
                subset.to_excel(writer, sheet_name=sheet_name, index=False)
