def apply_uma_exceptions(df):
    """
    Exceptions UMA bas√©es UNIQUEMENT sur les codes UMA,
    MAIS appliqu√©es uniquement aux lignes concern√©es (TIM + SITE + UMA),
    et non √† toutes les lignes d‚Äôun TIM.
    """

    print("\n======= DEBUG APPLY_UMA_EXCEPTIONS (corrig√©e) =======")

    # Aper√ßu utile
    print("UMA HC (codes) :", df["UMA_HC_code"].unique()[:20])
    print("UMA HDJ (codes):", df["UMA_HDJ_code"].unique()[:20])

    # ----------------------------------------------------------------------
    # 1Ô∏è‚É£  Exception : UMA 150 (HC) sur HTD
    # üéØ Cliniciens re√ßoit le TOTAL 150/HTD en cod√©s,
    #    tous les autres TIM re√ßoivent ce m√™me TOTAL en relanc√©s.
    # ----------------------------------------------------------------------
    mask_150_hc = (df["SITE"] == "HTD") & (df["UMA_HC_code"] == "150")
    if mask_150_hc.any():
        debug_rows = df.loc[mask_150_hc, ["TIM", "SITE", "UMA HC", "RUM cod√©s mois"]]
        print("\n-- UMA 150 HC sur HTD (lignes trouv√©es) --")
        print(debug_rows)

        # TOTAL 150/HTD (en se basant sur les valeurs actuellement dans "cod√©s")
        val_mois = df.loc[mask_150_hc, "RUM cod√©s mois"].sum()
        val_cum = df.loc[mask_150_hc, "RUM cod√©s cumul√©s"].sum()
        print(f"[150 HTD] Somme mois={val_mois}, cumul={val_cum}")

        # Cliniciens ‚Üí re√ßoit tout le total en COD√âS
        mask_cliniciens_150 = mask_150_hc & (df["TIM"] == "Cliniciens")
        df.loc[mask_cliniciens_150, "RUM cod√©s mois"] = val_mois
        df.loc[mask_cliniciens_150, "RUM cod√©s cumul√©s"] = val_cum

        # Autres TIM ‚Üí re√ßoivent le TOTAL en RELANC√âS (et plus leur valeur partag√©e)
        mask_other_tim_150 = mask_150_hc & (df["TIM"] != "Cliniciens")
        df.loc[mask_other_tim_150, "RUM relanc√©s mois"] = val_mois
        df.loc[mask_other_tim_150, "RUM relanc√©s cumul√©s"] = val_cum

        # On efface les cod√©s uniquement sur les lignes des autres TIM
        df.loc[mask_other_tim_150, ["RUM cod√©s mois", "RUM cod√©s cumul√©s"]] = np.nan

    # ----------------------------------------------------------------------
    # 2Ô∏è‚É£  Exception : UMA 040X (HC) sur CCH
    # üéØ Tout passe de cod√©s ‚Üí relanc√©s.
    # ----------------------------------------------------------------------
    mask_040x = (df["SITE"] == "CCH") & (df["UMA_HC_code"] == "040X")
    if mask_040x.any():
        print("\n-- UMA 040X HC sur CCH --")
        print(df.loc[mask_040x, ["TIM", "SITE", "UMA HC", "RUM cod√©s mois"]])

        df.loc[mask_040x, "RUM relanc√©s mois"] = df.loc[mask_040x, "RUM cod√©s mois"]
        df.loc[mask_040x, "RUM relanc√©s cumul√©s"] = df.loc[mask_040x, "RUM cod√©s cumul√©s"]

        df.loc[mask_040x, ["RUM cod√©s mois", "RUM cod√©s cumul√©s"]] = np.nan

    # ----------------------------------------------------------------------
    # 3Ô∏è‚É£  Exceptions HDJ ‚Üí bascule dans COD√âS
    # UMA HDJ sp√©ciales : 561C, 591C, 591J sur CCH
    # üéØ relanc√©s ‚Üí cod√©s, relanc√©s vid√©s.
    # ----------------------------------------------------------------------
    HDJ_SPECIAL = ["561C", "591C", "591J"]

    for code in HDJ_SPECIAL:
        mask_hdj_special = (df["SITE"] == "CCH") & (df["UMA_HDJ_code"] == code)

        if mask_hdj_special.any():
            print(f"\n-- UMA {code} HDJ ‚Üí bascule COD√âS --")
            print(df.loc[mask_hdj_special, ["TIM", "SITE", "UMA HDJ", "RUM relanc√©s mois"]])

            df.loc[mask_hdj_special, "RUM cod√©s mois"] = df.loc[mask_hdj_special, "RUM relanc√©s mois"]
            df.loc[mask_hdj_special, "RUM cod√©s cumul√©s"] = df.loc[mask_hdj_special, "RUM relanc√©s cumul√©s"]

            df.loc[mask_hdj_special, ["RUM relanc√©s mois", "RUM relanc√©s cumul√©s"]] = np.nan

    print("======= FIN APPLY_UMA_EXCEPTIONS =======\n")
    return df
