def generer_excel(df, annee_new, annee_old):
    output = BytesIO()
    wb = Workbook()
    ws = wb.active
    ws.title = "Comparatif"

    titre = f"Comparatif {annee_new} vs {annee_old}"
    ws.cell(row=1, column=1, value=titre).font = Font(size=14, bold=True)
    ws.cell(row=1, column=1).alignment = Alignment(horizontal="center")
    ws.merge_cells(start_row=1, start_column=1, end_row=1, end_column=len(df.columns))

    header_fill = PatternFill("solid", fgColor="D9D9D9")
    thin_border = Border(left=Side(style='thin'), right=Side(style='thin'),
                         top=Side(style='thin'), bottom=Side(style='thin'))
    for j, col in enumerate(df.columns, start=1):
        cell = ws.cell(row=2, column=j, value=col)
        cell.font = Font(bold=True)
        cell.alignment = Alignment(horizontal="center")
        cell.fill = header_fill
        cell.border = thin_border

    for i, row in enumerate(df.values, start=3):
        bg_fill = PatternFill("solid", fgColor="FFFFFF" if (i-3) % 2 == 0 else "F2F2F2")
        for j, val in enumerate(row, start=1):
            col_name = df.columns[j-1]
            cell = ws.cell(row=i, column=j)
            if "Valorisation" in col_name or "Écart Valorisation" in col_name:
                if pd.notna(val):
                    cell.value = format_valeur_monetaire(val)
                    if val < 0: 
                        cell.font = Font(color="FF0000")
            elif "Quantité" in col_name and pd.notna(val):
                cell.value = format_quantite(val)
                cell.font = Font(italic=True)
            elif "Unité" in col_name:
                cell.value = str(val)
                cell.font = Font(italic=True)
            else:
                cell.value = val
            cell.border = thin_border
            cell.fill = bg_fill

    for j, col in enumerate(df.columns, start=1):
        max_len = max(len(str(col)), *(len(str(ws.cell(row=i, column=j).value)) for i in range(3, len(df)+3) if ws.cell(row=i, column=j).value))
        ws.column_dimensions[ws.cell(row=2, column=j).column_letter].width = max_len + 2

    wb.save(output)
    output.seek(0)
    return output
