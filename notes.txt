def generer_excel(df, annee_new, annee_old):
    try:
        output = BytesIO()
        titre = f"Comparatif {annee_new} vs {annee_old}"

        # Quantité en entier
        for col in df.columns:
            if "Quantité" in col:
                df[col] = df[col].apply(lambda x: int(x) if pd.notna(x) else x)

        with pd.ExcelWriter(output, engine='openpyxl') as writer:
            df.to_excel(writer, index=False, sheet_name="Comparatif", startrow=1)
            wb = writer.book
            ws = wb["Comparatif"]

            # Titre ligne 1
            cell_titre = ws.cell(row=1, column=1)
            cell_titre.value = titre
            cell_titre.font = Font(size=14, bold=True)
            cell_titre.alignment = Alignment(horizontal="center")
            ws.merge_cells(start_row=1, start_column=1, end_row=1, end_column=df.shape[1])

            # Colonnes Valorisation + Écart
            valorisation_cols_idx = [i+1 for i, c in enumerate(df.columns) if "Valorisation" in c or "Écart Valorisation" in c]

            # Formater les valeurs monétaires (rouge si négatif)
            for row in range(3, len(df) + 3):
                for col_idx in valorisation_cols_idx:
                    cell = ws.cell(row=row, column=col_idx)
                    val = cell.value
                    if val is None or val == "":
                        cell.value = ""
                        continue
                    try:
                        val_float = float(val)
                        cell.value = format_valeur_monetaire_cell(val_float)
                        if val_float < 0:
                            cell.font = Font(color="FF0000")
                    except Exception:
                        pass

        output.seek(0)
        return output

    except Exception as e:
        raise RuntimeError("Impossible de générer le fichier Excel.") from e
