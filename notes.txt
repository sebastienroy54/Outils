import streamlit as st
import pandas as pd
import numpy as np
import re
from io import BytesIO
import openpyxl
import subprocess
from pathlib import Path
import cx_Oracle  # Assure-toi d'avoir install√© cx_Oracle pour le test de connexion

# -------------------------
# OUTILS
# -------------------------

def safe_show_exception(e):
    st.error("Une erreur est survenue. V√©rifiez vos fichiers ou contactez le support.")
    if st.checkbox("Afficher d√©tails techniques"):
        st.exception(e)

def normaliser_texte(val):
    if val is None:
        return ""
    return str(val).strip().lower().replace("\n", " ")

def trouver_feuille_avec_colonnes(fichier, colonnes_attendues, max_scan=50, debug=False):
    fichier.seek(0)
    wb = openpyxl.load_workbook(fichier, data_only=True)
    colonnes_norm = [normaliser_texte(c) for c in colonnes_attendues]

    for sheetname in wb.sheetnames:
        fichier.seek(0)
        df = pd.read_excel(fichier, sheet_name=sheetname, header=None, dtype=str, engine="openpyxl")
        if debug:
            st.write(f"--- FEUILLE : {sheetname} ---")
            st.write(df.head())
        for i in range(min(len(df), max_scan)):
            row = df.iloc[i].tolist()
            row_norm = [normaliser_texte(x) for x in row]
            if any("=" in str(x) for x in row_norm):
                continue
            if sum(x.strip() not in ["", "none", "nan"] for x in row_norm) < 2:
                continue
            if all(col in row_norm for col in colonnes_norm):
                fichier.seek(0)
                df_final = pd.read_excel(
                    fichier,
                    sheet_name=sheetname,
                    header=i,
                    dtype=str,
                    engine="openpyxl"
                )
                return df_final, sheetname, i
    raise ValueError(f"Aucune feuille ne contient les colonnes {colonnes_attendues}")

def nettoyer_ipp(val):
    if val is None:
        return ""
    val = re.sub(r"\D", "", str(val))
    return val[-10:] if len(val) >= 10 else ""

def fusion_excel(df1, df2, df3):
    for df in [df1, df2, df3]:
        df.columns = [normaliser_texte(c) for c in df.columns]

    df1 = df1.rename(columns={"c": "nom", "pr√©nom": "prenom"})
    df2 = df2.rename(columns={"nom": "nom", "pr√©nom": "prenom", "ddn": "ddn", "nip": "ipp"})
    df3 = df3.rename(columns={"nom": "nom", "pr√©nom": "prenom", "ddn": "ddn", "ipp": "ipp"})

    for df in [df1, df2, df3]:
        for col in ["nom", "prenom"]:
            df[col] = df[col].astype(str).str.strip().str.upper()

    df2["ipp"] = df2["ipp"].apply(nettoyer_ipp)
    df3["ipp"] = df3["ipp"].apply(nettoyer_ipp)

    df2 = df2.loc[:, ~df2.columns.duplicated()]
    df3 = df3.loc[:, ~df3.columns.duplicated()]
    ref = pd.concat([df2, df3], ignore_index=True)
    ref = ref.drop_duplicates(subset=["nom", "prenom", "ipp"])

    df_merge = df1.merge(ref, on=["nom", "prenom"], how="inner")
    df_merge["ddn"] = pd.to_datetime(df_merge["ddn"], errors="coerce", dayfirst=True)
    df_merge["ddn"] = df_merge["ddn"].dt.strftime("%d/%m/%Y")
    df_merge = df_merge.sort_values(by="nom").reset_index(drop=True)
    return df_merge[["nom", "prenom", "ddn", "ipp"]]

def generer_excel(df):
    output = BytesIO()
    with pd.ExcelWriter(output, engine="openpyxl") as writer:
        df.to_excel(writer, index=False, sheet_name="Croisement")
    return output.getvalue()

def generer_sql_bhre(fichier_sql_base, liste_ipps, fichier_sql_temp):
    ipps_txt = ",".join(f"'{ipp}'" for ipp in liste_ipps)
    sql_base = Path(fichier_sql_base).read_text(encoding="utf-8")
    sql_final = sql_base.replace("--IPP_PLACEHOLDER--", ipps_txt)
    Path(fichier_sql_temp).write_text(sql_final, encoding="utf-8")
    return fichier_sql_temp

# -------------------------
# INTERFACE STREAMLIT
# -------------------------

def main():
    st.title("Portail BHRe")

    if "oracle_connected" not in st.session_state:
        st.session_state["oracle_connected"] = False

    # --- Page 1 : Login Oracle ---
    if not st.session_state["oracle_connected"]:
        st.subheader("Connexion Oracle")
        with st.form("connexion"):
            user = st.text_input("üë§ Nom d'utilisateur Oracle :", value="")
            password = st.text_input("üîë Mot de passe :", type="password")
            submitted = st.form_submit_button("üöÄ Connexion")

        if submitted:
            if not user or not password:
                st.error("Veuillez renseigner vos identifiants Oracle.")
                st.stop()
            else:
                try:
                    # Test rapide de connexion
                    dsn = cx_Oracle.makedsn("SIP1CCH.WORLD", 1521, service_name=None)
                    conn = cx_Oracle.connect(user=user, password=password, dsn=dsn)
                    conn.close()
                    st.success("‚úÖ Connexion r√©ussie !")
                    st.session_state["oracle_connected"] = True
                    st.session_state["oracle_user"] = user
                    st.session_state["oracle_password"] = password
                except Exception as e:
                    st.error("‚ùå Connexion √©chou√©e. V√©rifiez vos identifiants.")
                    safe_show_exception(e)
        st.stop()  # Stop pour ne pas afficher le reste avant connexion

    # --- Page 2 : Upload et traitement BHRe ---
    st.subheader("üóÇÔ∏è Importez les trois fichiers Excel")
    fichier1 = st.file_uploader("Fichier Indicateur (F1)", type=["xlsx"])
    fichier2 = st.file_uploader("Fichier Suivi Termin√© (F2)", type=["xlsx"])
    fichier3 = st.file_uploader("Fichier Suivi (F3)", type=["xlsx"])
    debug = st.checkbox("Afficher mode debug")

    if fichier1 and fichier2 and fichier3:
        try:
            progress = st.progress(0)
            st.info("üîç Analyse des fichiers...")

            df1, feuil1, ligne1 = trouver_feuille_avec_colonnes(fichier1, ["c", "pr√©nom"], debug=debug)
            st.success(f"F1 ‚Üí feuille : {feuil1} (header ligne {ligne1})")
            progress.progress(20)

            df2, feuil2, ligne2 = trouver_feuille_avec_colonnes(fichier2, ["nom", "pr√©nom", "ddn", "nip"], debug=debug)
            st.success(f"F2 ‚Üí feuille : {feuil2} (header ligne {ligne2})")
            progress.progress(40)

            df3, feuil3, ligne3 = trouver_feuille_avec_colonnes(fichier3, ["nom", "pr√©nom", "ddn", "ipp"], debug=debug)
            st.success(f"F3 ‚Üí feuille : {feuil3} (header ligne {ligne3})")
            progress.progress(60)

            st.info("üîó Fusion des fichiers...")
            df_result = fusion_excel(df1, df2, df3)
            st.success("Fusion termin√©e !")
            st.dataframe(df_result.head())
            progress.progress(80)

            # Sauvegarde fusion
            dossier_data = Path("C:/Users/4251352/Portail_outils/data")
            dossier_data.mkdir(parents=True, exist_ok=True)
            fichier_excel_final = dossier_data / "Fusion_excel.xlsx"
            with pd.ExcelWriter(fichier_excel_final, engine="openpyxl") as writer:
                df_result.to_excel(writer, index=False, sheet_name="Croisement")

            # --- G√©n√©ration SQL et ex√©cution ---
            fichier_sql_base = Path("C:/Users/4251352/Portail_outils/SQL/BHRe_base.sql")
            fichier_sql_temp = dossier_data / "BHRe_temp.sql"
            liste_ipps = df_result["ipp"].dropna().unique().tolist()
            generer_sql_bhre(fichier_sql_base, liste_ipps, fichier_sql_temp)

            st.info("üß† Ex√©cution requ√™te SQL...")
            tns_alias = "SIP1CCH.WORLD"
            cmd = f"sqlplus {st.session_state['oracle_user']}/{st.session_state['oracle_password']}@{tns_alias} @{fichier_sql_temp}"
            subprocess.run(cmd, shell=True)
            st.success("Requ√™te SQL termin√©e.")

            # --- Conversion CSV ‚Üí Excel ---
            fichier_csv = dossier_data / "BHRe.csv"
            if fichier_csv.exists():
                df_csv = pd.read_csv(fichier_csv, sep=";")
                fichier_csv_excel = dossier_data / "BHRe.xlsx"
                with pd.ExcelWriter(fichier_csv_excel, engine="openpyxl") as writer:
                    df_csv.to_excel(writer, index=False, sheet_name="BHRe")
                fichier_csv.unlink()  # Supprime le CSV
                st.success("Conversion CSV ‚Üí Excel termin√©e.")
                st.download_button(
                    label="üíæ T√©l√©charger BHRe.xlsx",
                    data=fichier_csv_excel.read_bytes(),
                    file_name="BHRe.xlsx",
                    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                )

            progress.progress(100)

        except Exception as e:
            safe_show_exception(e)


if __name__ == "__main__":
    main()
