import streamlit as st
import pandas as pd
from io import BytesIO
from openpyxl.styles import Font, Alignment, PatternFill

def lire_fichier_excel(fichier):
    """Lit un fichier Excel et renvoie les m√©tadonn√©es et le tableau nettoy√©."""
    df = pd.read_excel(fichier, header=None)

    # R√©cup√©ration des m√©tadonn√©es
    resume_filtrage = df.iloc[3, 0]
    periode = str(df.iloc[4, 0])  # Contient la p√©riode (ex : "P√©riode : 2025")
    filtres = df.iloc[5, 0]
    detail_valo = df.iloc[7, 0]

    # Extraction de l'ann√©e √† partir de la ligne de p√©riode
    import re
    match = re.search(r"(\d{4})", periode)
    annee = match.group(1) if match else "XXXX"

    # Lecture du tableau de donn√©es √† partir de la ligne 9 (index 8)
    data = pd.read_excel(fichier, header=8)
    data = data.iloc[:, :4]
    data.columns = ["Indicateur", "Valorisation", "Quantit√©", "Unit√©"]

    return annee, data, {
        "R√©sum√© de filtrage": resume_filtrage,
        "P√©riode": periode,
        "Filtres": filtres,
        "D√©tail valorisation": detail_valo
    }

def creer_tableau_comparatif(df_new, annee_new, df_old, annee_old):
    """Fusionne et compare deux DataFrames selon les indicateurs, en gardant l'ordre du premier fichier."""
    df_new = df_new.rename(columns={
        "Valorisation": f"Valorisation {annee_new}",
        "Quantit√©": f"Quantit√© {annee_new}",
        "Unit√©": f"Unit√© {annee_new}"
    })
    df_old = df_old.rename(columns={
        "Valorisation": f"Valorisation {annee_old}",
        "Quantit√©": f"Quantit√© {annee_old}",
        "Unit√©": f"Unit√© {annee_old}"
    })

    # Fusion en gardant l'ordre du fichier le plus r√©cent
    df_merge = pd.merge(df_new, df_old, on="Indicateur", how="left", sort=False)

    # Calcul de l‚Äô√©cart de valorisation
    df_merge[f"√âcart Valorisation ({annee_new}-{annee_old})"] = (
        df_merge[f"Valorisation {annee_new}"] - df_merge[f"Valorisation {annee_old}"]
    )

    return df_merge

def format_valorisation(val):
    """Formate une valeur mon√©taire : espaces pour milliers et ‚Ç¨."""
    try:
        if pd.isna(val):
            return ""
        val = float(val)
        return f"{val:,.0f} ‚Ç¨".replace(",", " ").replace(".", ",")
    except:
        return val

def generer_excel(df, annee_new, annee_old):
    """Cr√©e un fichier Excel stylis√© avec valeurs n√©gatives en rouge et format mon√©taire."""
    output = BytesIO()
    titre = f"Comparatif {annee_new} vs {annee_old}"

    with pd.ExcelWriter(output, engine='openpyxl') as writer:
        # On √©crit le tableau √† partir de la ligne 2 (ligne 1 = titre)
        df.to_excel(writer, index=False, sheet_name="Comparatif", startrow=1)
        wb = writer.book
        ws = wb["Comparatif"]

        # Ins√©rer le titre en haut
        ws.cell(row=1, column=1, value=titre)
        ws.cell(row=1, column=1).font = Font(size=14, bold=True)
        ws.merge_cells(start_row=1, start_column=1, end_row=1, end_column=df.shape[1])
        ws.cell(row=1, column=1).alignment = Alignment(horizontal="center")

        # Mise en forme de l‚Äôen-t√™te
        header_fill = PatternFill(start_color="D9D9D9", end_color="D9D9D9", fill_type="solid")
        for cell in ws[2]:
            cell.font = Font(bold=True)
            cell.fill = header_fill
            cell.alignment = Alignment(horizontal="center")

        # Identifier les colonnes de valorisation et √©cart
        valorisation_cols = [i + 1 for i, c in enumerate(df.columns)
                             if "Valorisation" in c]

        # Mise en forme des cellules
        for row in range(3, len(df) + 3):  # √† partir de la 3e ligne
            for col in valorisation_cols:
                cell = ws.cell(row=row, column=col)
                try:
                    val = float(cell.value)
                    cell.value = f"{val:,.0f} ‚Ç¨".replace(",", " ").replace(".", ",")
                    if val < 0:
                        cell.font = Font(color="FF0000")  # rouge si n√©gatif
                except:
                    pass

        # Ajustement de la largeur des colonnes
        for col in ws.columns:
            max_length = 0
            col_letter = col[0].column_letter
            for cell in col:
                if cell.value:
                    max_length = max(max_length, len(str(cell.value)))
            ws.column_dimensions[col_letter].width = max_length + 2

    output.seek(0)
    return output

def afficher_tableau_colore(df, annee_new, annee_old):
    """Affiche le tableau dans Streamlit avec mise en forme rouge et formatage ‚Ç¨."""
    valorisation_cols = [c for c in df.columns if "Valorisation" in c]

    def format_val(v):
        try:
            if pd.isna(v):
                return ""
            return f"{v:,.0f} ‚Ç¨".replace(",", " ").replace(".", ",")
        except:
            return v

    def color_neg(v):
        return 'color: red' if isinstance(v, (int, float)) and v < 0 else ''

    df_styled = df.copy()
    for col in valorisation_cols:
        df_styled[col] = df_styled[col].apply(format_val)

    st.markdown(f"### üìä Comparatif {annee_new} vs {annee_old}")
    st.dataframe(df_styled.style.applymap(color_neg, subset=valorisation_cols))

def main():
    st.title("üí∂ Comparateur de Valorisation T2A")

    st.write("### üóÇÔ∏è Importez les deux fichiers Excel")
    fichier1 = st.file_uploader("Fichier r√©cent (ex: 2025)", type=["xlsx"], key="file1")
    fichier2 = st.file_uploader("Fichier ancien (ex: 2024)", type=["xlsx"], key="file2")

    if fichier1 and fichier2:
        annee1, df1, meta1 = lire_fichier_excel(fichier1)
        annee2, df2, meta2 = lire_fichier_excel(fichier2)

        # V√©rifie si les fichiers sont invers√©s et corrige automatiquement
        if int(annee1) < int(annee2):
            st.warning(f"‚ö†Ô∏è Inversion d√©tect√©e : le fichier {annee1} semble plus ancien que {annee2}. Inversion automatique.")
            df1, df2 = df2, df1
            annee1, annee2 = annee2, annee1

        st.write("### üßæ M√©tadonn√©es")
        st.write(f"**P√©riode {annee1} :** {meta1['P√©riode']}")
        st.write(f"**P√©riode {annee2} :** {meta2['P√©riode']}")

        df_comparatif = creer_tableau_comparatif(df1, annee1, df2, annee2)
        afficher_tableau_colore(df_comparatif, annee1, annee2)

        # G√©n√©ration du fichier Excel √† t√©l√©charger
        excel_data = generer_excel(df_comparatif, annee1, annee2)
        st.download_button(
            label="üíæ T√©l√©charger le comparatif (Excel)",
            data=excel_data,
            file_name=f"Comparatif_{annee1}_{annee2}.xlsx",
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )

if __name__ == "__main__":
    main()
