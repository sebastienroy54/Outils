import os
from pathlib import Path
from oracle_runner import run_sqlplus
from txt_to_excel import txt_to_excel
from code_decoupage import decouper_excel
from mailer import send_mail

BASE = Path("/app")
OUTPUT = BASE / "output"

CONFIGS = {
    "CCH": ("ORACLE_CCH_DSN", "MONO_UHCD_CCH.sql", "MONO_UHCD_CCH.txt"),
    "HTD": ("ORACLE_HTD_DSN", "MONO_UHCD_HTD.sql", "MONO_UHCD_HTD.txt")
}

generated_files = []

for site, (dsn_env, sql, txt) in CONFIGS.items():
    site_dir = OUTPUT / site
    run_sqlplus(BASE/"sql"/sql, site_dir,
                os.environ["ORACLE_USER"],
                os.environ["ORACLE_PASSWORD"],
                os.environ[dsn_env])

    xlsx = site_dir / f"{site}.xlsx"
    final = site_dir / f"{site}_FINAL.xlsx"

    txt_to_excel(site_dir/txt, xlsx)
    decouper_excel(xlsx, final)

    generated_files.append(final)

send_mail(
    subject="MONO UHCD – Rapport hebdomadaire",
    body="Veuillez trouver les fichiers en pièce jointe.",
    attachments=generated_files
)
