import pandas as pd
from pathlib import Path

PATRON_XLSX = Path("C:/Users/4251352/Portail_outils/data/tableau_rum_tim.xlsx")

def extract_uma_code(uma):
    if not isinstance(uma, str):
        return ""
    if "-" in uma:
        return uma.split("-")[0].strip()
    return uma.split()[0].strip()

def extract_tim_list(value):
    if not isinstance(value, str):
        return []
    # Sépare sur "/" et nettoie
    parts = [v.strip() for v in value.split("/") if v.strip()]
    return parts

def build_tim_uma_dict(patron_path):
    df = pd.read_excel(patron_path, engine="openpyxl", dtype=str)
    df["Site"] = df["Site"].astype(str).str.strip()
    df["UMA"] = df["UMA"].astype(str).str.strip()

    tim_dict = {}

    for _, row in df.iterrows():
        site = row["Site"]
        uma = row["UMA"]

        if not uma or uma.startswith("Total DMU"):
            continue

        uma_code = extract_uma_code(uma)

        # Récupération TIM référent + relance
        tims_ref = extract_tim_list(row.get("TIM référent", ""))
        tims_rel = extract_tim_list(row.get("Relance", ""))

        tims = set(tims_ref + tims_rel)
        tims.discard("")  # on enlève vide

        for tim in tims:
            if tim not in tim_dict:
                tim_dict[tim] = {}
            tim_dict[tim][site] = uma_code

    return tim_dict


if __name__ == "__main__":
    result = build_tim_uma_dict(PATRON_XLSX)
    for tim, sites in result.items():
        print(f"{tim} = {sites}")
